<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infografía - Anexo I (Parte I) — ITC</title>
  <style>
    :root{
      --primary-color: #1E5B4F;
      --secondary-color: #A6802D;
      --accent-color: #9C2348;
      --bg:#ffffff;
      --muted:#666;
      --page-width:1000px; /* good for pdf export */
      --gutter:24px;
    }
    body{font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#111; margin:0; padding:24px;}
    .page{width:var(--page-width); margin:0 auto; box-sizing:border-box}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{font-size:20px;color:var(--primary-color);margin:0}
    h2{font-size:16px;color:var(--secondary-color);margin:8px 0}
    h3{font-size:14px;color:var(--accent-color);margin:8px 0}
    .meta{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gutter);}
    .card{background:#fff;border:1px solid #eee;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.03)}
    .chart{height:220px}
    .small{height:140px}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;font-size:12px}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .swatch{width:12px;height:12px;border-radius:3px;display:inline-block}
    table.stats{width:100%;border-collapse:collapse;font-size:12px}
    table.stats th, table.stats td{padding:6px;border:1px solid #eee;text-align:right}
    table.stats th{background: #e8f0ef; color: var(--primary-color); text-align:left; font-weight: 600;}
    .chart-container { display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .flex-container { display: flex; align-items: center; gap: var(--gutter); flex-wrap: wrap; }
    .flex-container > div { flex: 1; min-width: 300px; }

    @media print{body{padding:8px} .page{width:100%;} .chart, .small{height:180px}}
    .intro-text, .chart-context {
      font-size: 13px;
      line-height: 1.6;
      color: #333;
      margin: 4px 0 16px 0;
      text-align: justify;
    }
    strong {
      font-weight: 600;
      color: var(--secondary-color);
    }
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    /* --- Estilos para Tooltip Interactivo --- */
    #chart-tooltip {
      position: absolute;
      display: none;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none; /* Evita que el tooltip interfiera con el mouse */
      white-space: pre;
      transition: opacity 0.2s;
    }
    .kpi-container { display: flex; gap: var(--gutter); margin-bottom: 12px; }
    .kpi-card { flex: 1; background: #f8f9fa; border: 1px solid #eee; padding: 12px; border-radius: 8px; text-align: center; }
    .kpi-value { font-size: 22px; font-weight: 700; color: var(--primary-color); margin: 4px 0; }
    .kpi-label { font-size: 12px; color: var(--muted); }
    .positive { color: #28a745; font-weight: 600; }
    .negative { color: #dc3545; font-weight: 600; }
    footer{font-size:11px;color:var(--muted);margin-top:18px}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <h1>Resumen de Infografía - Industria Textil y de la Confección (ITC)</h1>
        <p class="intro-text" style="margin-bottom:0;">
          Este documento presenta un resumen visual de los principales indicadores y tendencias de la Industria Textil y de la Confección (ITC), elaborado como parte del informe presentado a la Dirección General correspondiente.
        </p>
      </div>
      <div style="text-align:right">
        <div style="font-weight:600">Noviembre 2025</div>
      </div>
    </header>

    <section class="kpi-container">
      <div class="kpi-card">
        <div class="kpi-value"><span class="positive">+26.4%</span></div>
        <div class="kpi-label">Crecimiento Promedio del PIB Sectorial (2018-2024)</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value">$480.2 M</div>
        <div class="kpi-label">IED Acumulada (2019 - 2025 Q1)</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value">89.5%</div>
        <div class="kpi-label">Concentración de Exportaciones hacia EE.UU.</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value"><span class="negative">-$4,313 M</span></div>
        <div class="kpi-label">Déficit Comercial (Ene-Sep 2025)</div>
      </div>
    </section>

    <section class="card" style="margin-bottom:12px;">
      <h2>Panorama Estratégico de la Industria Textil y de la Confección (ITC)</h2>
      <p class="intro-text" style="margin-bottom: 8px;">
        La presente infografía se genera para dotar a la Dirección General de información actualizada y contextualizada sobre la ITC, con el objetivo de definir estrategias que impulsen su desarrollo sostenido. El foco del estudio son los subsectores SCIAN 313, 314 y 315, bajo la intervención estratégica "Protección Activa".
      </p>
      <p class="intro-text">A continuación, se presentan los principales resultados derivados del análisis realizado, los cuales permiten establecer el siguiente panorama:</p>
      <ul class="intro-text" style="margin-top:0; padding-left: 20px;">
        <li>
          <strong>Agravamiento del Desequilibrio Comercial Total:</strong> Contrario a la meta de contención, el déficit comercial de la ITC se aceleró en 2025. El déficit acumulado a septiembre alcanzó <strong>–US$ 4,313 millones</strong>, cifra superior al déficit de todo el periodo Ene-Nov de 2024 (–US$ 4,280 millones).<sup>11</sup> Este incremento evidencia la necesidad de reforzar las medidas de fiscalización.
        </li>
        <li>
          <strong>Divergencia Crítica en Flujos de IED:</strong> La IED acumulada (2019-2025 Q3) asciende a <strong>$480.1 millones de dólares</strong>.<sup>3,10</sup> Se observa una disparidad crítica: mientras los subsectores de insumos (313 y 314) muestran TCMA positivas (<strong>+15.3%</strong> y <strong>+22.6%</strong>), el subsector de confección (315), de mayor valor agregado, registra una contracción de <strong>-7.7%</strong> en su TCMA de IED.<sup>14</sup>
        </li>
        <li>
          <strong>Resiliencia Estructural del PIB:</strong> A pesar de la coyuntura, el PIB sectorial muestra una base sólida. Entre 2018 y 2024, todos los subsectores crecieron a precios constantes, destacando el SCIAN 315 con una expansión de <strong>+30.1%</strong>.<sup>2</sup> Esto confirma que la política de "Protección Activa" busca blindar un sector con fundamentos sanos frente a la competencia desleal.<sup>6</sup>
        </li>
      </ul>
    </section>


    <section class="card">
      <h2>Resumen ejecutivo (visual)</h2>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div style="flex:1.2;min-width:220px">
          <h3>Balance Comercial — Coyuntura 2025</h3>
          <p class="chart-context" style="margin-top:0;">
            El déficit comercial se ha agravado: en solo nueve meses de 2025 (<strong>–$4,313 MM USD</strong>) ya supera el acumulado de once meses de 2024 (–$4,280 MM USD). Este desequilibrio equivale al <strong>77.6% del valor exportado</strong>, lo que evidencia que las medidas arancelarias no han sido suficientes para contener los flujos de comercio desleal.
          </p>
          <div class="chart" id="chart-balance"></div>
          <div class="legend">
            <span><i class="swatch" style="background:var(--primary-color)"></i>Importaciones</span>
            <span><i class="swatch" style="background:var(--secondary-color)"></i>Exportaciones</span>
            <span><i class="swatch" style="background:var(--accent-color)"></i>Déficit</span>
          </div>
          <div class="note">Datos en Millones de USD.</div>
        </div>
        <div style="flex:1;min-width:260px; border-left: 1px solid #eee; padding-left: 12px;">
          <h3>IED acumulada (2019 - 2025 Q1)</h3>
          <p class="chart-context" style="margin-top:0;">
            La IED acumulada totaliza <strong>$480.2 MM USD</strong>. El subsector de confección (SCIAN 315) atrae la mayor parte ($229.8 MM), mientras que la fabricación de insumos (313 y 314) muestra una oportunidad para atraer inversión y fortalecer la cadena productiva.
          </p>
          <div class="small" id="chart-ied"></div>
          <div class="legend">
            <span><i class="swatch" style="background:var(--primary-color)"></i>313</span>
            <span><i class="swatch" style="background:var(--secondary-color)"></i>314</span>
            <span><i class="swatch" style="background:var(--accent-color)"></i>315</span>
          </div>
          <div class="note">IED Total sector ITC: 480.2 M USD. Tendencia positiva en subsectores 313 y 314; negativa en 315.</div>
        </div>
      </div>
    </section>

    <section class="grid" style="margin-top:12px">
      <div class="card">
        <h2>PIB — Índice 2018=100 (2018–Sep 2025)</h2>
        <p class="chart-context">
          El Producto Interno Bruto (PIB) sectorial (2020 Q1 - 2025 Q3) muestra una fuerte volatilidad post-pandemia. Tras un declive en 2020, la recuperación fue notable en 2021 y 2022. Sin embargo, en 2023 y el inicio de 2024 se observa una desaceleración, que se proyecta se estabilice hacia el Q3 de 2025 en un nivel similar al promedio histórico.
        </p>
        <div class="chart" id="chart-pib"></div>
        <div class="legend">
          <span><i class="swatch" style="background:var(--primary-color)"></i>313</span>
          <span><i class="swatch" style="background:var(--secondary-color)"></i>314</span>
          <span><i class="swatch" style="background:var(--accent-color)"></i>315</span>
        </div>
        <div class="note">Subsectores: 313, 314, 315. 315 presenta el mayor crecimiento acumulado (+30.1% respecto 2018).</div>
        <table class="stats" style="margin-top:8px">
          <thead><tr><th>Subsector (SCIAN)</th><th>2018</th><th>2019</th><th>2020</th><th>2021</th><th>2022</th><th>2023</th><th>2024</th><th>2025 Sep</th><th>% Δ 2018-2024</th></tr></thead>
          <tbody>
            <tr><td>313</td><td>100</td><td>101.1</td><td>104.2</td><td>109.6</td><td>122.5</td><td>122.1</td><td>123.6</td><td>126.0</td><td class="positive">+23.6%</td></tr>
            <tr><td>314</td><td>100</td><td>102.4</td><td>105.5</td><td>113.7</td><td>119.9</td><td>122.7</td><td>125.5</td><td>127.8</td><td class="positive">+25.5%</td></tr>
            <tr><td>315</td><td>100</td><td>105.3</td><td>110.2</td><td>118.5</td><td>130.3</td><td>126.8</td><td>130.1</td><td>135.5</td><td class="positive">+30.1%</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h2>IED por subsector — Serie (2019–2025 Q1)</h2>
        <p class="chart-context">
          La Inversión Extranjera Directa (IED) consolidada para el periodo 2020-2025 Q3 totalizó <strong>480.2 Millones de USD</strong>. El subsector SCIAN 315 (Fabricación de prendas de vestir) es el que históricamente atrae la mayor IED, con <strong>229.8 Millones de USD</strong>, reflejando la solidez de la cadena de valor final. En contraste, los subsectores 313 y 314 presentan niveles más moderados, indicando una posible área de oportunidad para atraer inversión a la producción de insumos intermedios.
        </p>
        <div class="chart" id="chart-ied-series"></div>
        <div class="legend">
          <span><i class="swatch" style="background:var(--primary-color)"></i>313</span>
          <span><i class="swatch" style="background:var(--secondary-color)"></i>314</span>
          <span><i class="swatch" style="background:var(--accent-color)"></i>315</span>
        </div>
        <table class="stats" style="margin-top:8px">
          <thead><tr><th>SCIAN</th><th>2019</th><th>2020</th><th>2021</th><th>2022</th><th>2023</th><th>2024</th><th>Mar 2025</th><th>Total (2019–2025Q1)</th><th>TCMA</th></tr></thead>
          <tbody>
            <tr><td>313</td><td>2.4</td><td>1.0</td><td>37.1</td><td>24.6</td><td>10.2</td><td>4.8</td><td>-5.8</td><td>74.3</td><td class="positive">+15.3%</td></tr>
            <tr><td>314</td><td>23.1</td><td>18.2</td><td>19.4</td><td>31.7</td><td>17.3</td><td>64.0</td><td>2.3</td><td>176.0</td><td class="positive">+22.6%</td></tr>
            <tr><td>315</td><td>76.3</td><td>23.2</td><td>8.0</td><td>62.5</td><td>-4.5</td><td>51.0</td><td>13.3</td><td>229.8</td><td class="negative">-7.7%</td></tr>
            <tr><td><strong>Total ITC</strong></td><td>101.8</td><td>42.4</td><td>64.5</td><td>118.8</td><td>23.0</td><td>119.9</td><td>9.8</td><td>480.2</td><td class="positive">+3.3%</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Serie Histórica de IED en Manufacturas y Comercio Relacionado</h2>
      <p class="chart-context">
        Para contextualizar la IED del sector ITC, se presenta la serie histórica del flujo de inversión hacia el sector Manufacturero y los subsectores relacionados con el comercio textil, con corte al primer trimestre de 2025 (Ene-Mar). La serie de IED en manufacturas demuestra la tendencia positiva y el alto potencial de atracción de inversión en México. Los subsectores relacionados con el comercio textil y de calzado muestran, en cambio, una alta volatilidad. Esta inestabilidad refleja la incertidumbre generada por la competencia desleal, lo que justifica la necesidad de blindar el mercado para estabilizar el entorno de inversión.
      </p>
      <div class="chart" id="chart-ied-manufacturas"></div>
      <div class="legend">
        <span><i class="swatch" style="background:var(--primary-color)"></i>Manufacturas (Total)</span>
        <span><i class="swatch" style="background:var(--secondary-color)"></i>Comercio al por mayor - Textiles y Calzado</span>
        <span><i class="swatch" style="background:var(--accent-color)"></i>Comercio al por menor - Textiles, accesorios y calzado</span>
      </div>
      <table class="stats" style="margin-top:8px">
        <thead><tr><th>SECTOR/SUBSECTOR</th><th>2020</th><th>2021</th><th>2022</th><th>2023</th><th>2024</th><th>2025</th></tr></thead>
        <tbody>
          <tr><td>Manufacturas (Total)</td><td>11,625.2</td><td>14,575.4</td><td>14,040.1</td><td>18,148.1</td><td>19,884.7</td><td>9,237.1</td></tr>
          <tr><td>Comercio al por mayor - Textiles y Calzado</td><td>9.3</td><td>-17.4</td><td>51.8</td><td>227.9</td><td>9.4</td><td>-5.3</td></tr>
          <tr><td>Comercio al por menor - Textiles, accesorios y calzado</td><td>19.4</td><td>10.7</td><td>5.3</td><td>35.6</td><td>-28.7</td><td>0.0</td></tr>
        </tbody>
      </table>
    </section>

    <section style="margin-top:12px" class="card">
        <h2>Producción y Ventas (Acumulado 2018 - 2025 Q3)</h2>
        <p class="chart-context">
          La Producción Nacional (2020 Q1 - 2025 Q3) se enfoca en el SCIAN 313 (Fabricación de insumos textiles y acabado de textiles). Este gráfico ilustra que, a pesar de los esfuerzos, la producción interna de insumos (hilos, telas, etc.) aún no satisface la demanda total de los subsectores 314 y 315. Se proyecta que las estrategias de <strong>"Protección Activa"</strong> busquen incrementar esta producción para reducir la dependencia de la cadena de suministro internacional y fortalecer la integración vertical.
        </p>

        <div class="grid">
          <div class="card">
            <h3>Valor en miles de pesos</h3>
            <div class="chart" id="chart-prod-val"></div>
            <div class="legend">
              <span><i class="swatch" style="background:var(--primary-color)"></i>Producción</span>
              <span><i class="swatch" style="background:var(--secondary-color)"></i>Ventas netas</span>
            </div>
            <table class="stats" style="margin-top:8px">
              <thead><tr><th>Subsector</th><th>Producción</th><th>Ventas netas</th><th>% Venta/Prod</th></tr></thead>
              <tbody>
                <tr><td>313</td><td>467,012,975</td><td>457,989,155</td><td>98.07%</td></tr>
                <tr><td>314</td><td>186,428,225</td><td>185,327,239</td><td>99.41%</td></tr>
                <tr><td>315</td><td>545,603,398</td><td>542,193,414</td><td>99.38%</td></tr>
                <tr><td><strong>Total</strong></td><td>1,199,044,598</td><td>1,185,559,808</td><td>98.87%</td></tr>
              </tbody>
            </table>
          </div>

          <div class="card">
            <h3>Unidades físicas (piezas)</h3>
            <div class="chart" id="chart-prod-qty"></div>
            <div class="legend">
              <span><i class="swatch" style="background:var(--primary-color)"></i>Producción (piezas)</span>
              <span><i class="swatch" style="background:var(--secondary-color)"></i>Ventas netas (piezas)</span>
            </div>
            <table class="stats" style="margin-top:8px">
              <thead><tr><th>Subsector</th><th>Producción (piezas)</th><th>Ventas netas (piezas)</th><th>% Cantidades</th></tr></thead>
              <tbody>
                <tr><td>313</td><td>4,492,568</td><td>4,400,535</td><td>97.95%</td></tr>
                <tr><td>314</td><td>303,663,003</td><td>296,722,051</td><td>97.71%</td></tr>
                <tr><td>315</td><td>688,381,603</td><td>670,934,639</td><td>97.47%</td></tr>
                <tr><td><strong>Total</strong></td><td>996,537,174</td><td>972,057,225</td><td>97.54%</td></tr>
              </tbody>
            </table>
          </div>
        </div>
    </section>

    <section style="margin-top:12px" class="card">
      <h2>Comercio exterior — Déficit y estructura por subsector</h2>
      <p class="chart-context">
        El análisis de la Balanza Comercial (Millones de USD) para el periodo revela un persistente déficit comercial en los tres subsectores de la ITC, lo que subraya la alta dependencia del sector de insumos importados. El subsector SCIAN 313 (Insumos textiles) presenta el mayor déficit, mientras que SCIAN 315 (Prendas de vestir) registra un menor déficit relativo, siendo el más competitivo en términos de exportaciones.
      </p>
      <div class="grid">
        <div class="card">
          <h3>Balanza Comercial (MM USD)</h3>
          <div class="chart" id="chart-trade"></div>
          <div class="legend">
            <span><i class="swatch" style="background:var(--primary-color)"></i>Importaciones</span>
            <span><i class="swatch" style="background:var(--secondary-color)"></i>Exportaciones</span>
            <span><i class="swatch" style="background:var(--accent-color)"></i>Déficit</span>
          </div>
          <table class="stats" style="margin-top:8px">
            <thead><tr><th>Periodo</th><th>Importaciones</th><th>Exportaciones</th><th>Déficit</th></tr></thead>
            <tbody>
              <tr><td>Cierre parcial 2024 (Ene-Nov)</td><td>12,394</td><td>8,114</td><td class="negative">–4,280</td></tr>
              <tr><td>Coyuntura 2025 (Ene-Sep)</td><td>9,874</td><td>5,561</td><td class="negative">–4,313</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h3>Balanza por subsector (2024) — Miles USD</h3>
          <div class="small" id="chart-balance-sub"></div>
          <table class="stats" style="margin-top:8px">
            <div class="legend">
              <span><i class="swatch" style="background:var(--primary-color)"></i>Importaciones</span>
              <span><i class="swatch" style="background:var(--secondary-color)"></i>Exportaciones</span>
              <span><i class="swatch" style="background:var(--accent-color)"></i>Balanza</span>
            </div>
            <br>
            <thead><tr><th>Subsector</th><th>Importaciones</th><th>Exportaciones</th><th>Balanza</th></tr></thead>
            <tbody>
              <tr><td>313</td><td>1,180,515</td><td>810,395</td><td class="negative">–370,120</td></tr>
              <tr><td>314</td><td>1,542,439</td><td>725,032</td><td class="negative">–817,407</td></tr>
              <tr><td>315</td><td>1,960,358</td><td>2,726,073</td><td class="positive">+765,715</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:18px; border-top: 1px solid #eee; padding-top: 12px;">
        <h2>Desglose del Desequilibrio Estructural y Tendencia Histórica</h2>
        
        <h3>Balanza Histórica Consolidada (2020-2024)</h3>
        <div class="flex-container">
          <div style="flex:1.5">
            <p class="chart-context">
              El sector de la Industria Textil y de la Confección (ITC) en México ha experimentado una transformación significativa en su patrón de comercio exterior durante el periodo 2020-2024. Históricamente, y particularmente durante el inicio del periodo de la pandemia (2020), el sector logró mantener un Superávit Comercial considerable. Sin embargo, a partir del año 2023, la tendencia se revierte drásticamente, pasando de generar un saldo positivo a registrar un Déficit Estructural. Este desequilibrio se profundiza en 2024, lo que subraya una creciente dependencia de las importaciones o una disminución en la competitividad exportadora.
            </p>
          </div>
          <div style="flex:1">
            <div class="chart" id="chart-balance-historic"></div>
            <div class="legend">
              <span><i class="swatch" style="background:var(--secondary-color)"></i>Exportaciones</span>
              <span><i class="swatch" style="background:var(--primary-color)"></i>Importaciones</span>
              <span><i class="swatch" style="background:var(--accent-color)"></i>Balanza</span>
            </div>
          </div>
        </div>
        <table class="stats" style="margin-top: 8px;">
          <caption>Tabla 5.2: Balanza Comercial Consolidada de la ITC (Miles de Dólares - USD)</caption>
          <thead>
            <tr><th>Año</th><th>Exportaciones Totales (E)</th><th>Importaciones Totales (I)</th><th>Balanza Comercial (E - I)</th><th>Comportamiento</th></tr>
          </thead>
          <tbody>
            <tr><td>2024</td><td>4,261,490</td><td>4,683,277</td><td class="negative">–421,787</td><td>Déficit</td></tr>
            <tr><td>2023</td><td>4,653,517</td><td>4,778,131</td><td class="negative">–124,614</td><td>Déficit</td></tr>
            <tr><td>2022</td><td>5,291,623</td><td>4,840,429</td><td class="positive">+451,194</td><td>Superávit</td></tr>
            <tr><td>2021</td><td>4,635,633</td><td>4,104,880</td><td class="positive">+530,753</td><td>Superávit</td></tr>
            <tr><td>2020</td><td>3,974,570</td><td>2,819,939</td><td class="positive">+1,154,631</td><td>Superávit</td></tr>
          </tbody>
        </table>
        <p class="chart-context" style="margin-top:16px;">
          El sector textil y de la confección en México experimentó una etapa de superávit coyuntural post-pandemia (2020-2022) impulsada inicialmente por la contracción de las importaciones. Sin embargo, la tendencia se revirtió bruscamente en 2023 y se agravó en 2024. Este deterioro en la balanza comercial sugiere que, a pesar de la alta actividad de exportación en el sector (evidenciada por los altos valores de 2022), la dependencia de insumos importados y la fuerte competencia global, especialmente en el mercado interno, están ejerciendo una presión significativa sobre el saldo comercial.
        </p>

        <h3 style="margin-top:18px;">Origen del Déficit por Subsector SCIAN (2024)</h3>
        <div class="flex-container">
          <div style="flex:1.5">
            <p class="chart-context">
              La pérdida de competitividad se concentra en la producción de insumos intermedios, mientras que la confección final mantiene un superávit. El sector 315 (Confección) es el único que genera un Superávit importante. Sin embargo, los subsectores 313 y 314 acumulan un déficit de $1,187 millones de dólares (Miles USD), evidenciando que la industria mexicana es altamente dependiente de insumos intermedios importados para alimentar su capacidad exportadora.
            </p>
          </div>
          <div style="flex:1">
            <div class="chart" id="chart-balance-subsector-2024"></div>
            <div class="legend">
              <span><i class="swatch" style="background:var(--secondary-color)"></i>Exportaciones</span>
              <span><i class="swatch" style="background:var(--primary-color)"></i>Importaciones</span>
              <span><i class="swatch" style="background:var(--accent-color)"></i>Balanza</span>
            </div>
          </div>
        </div>
        <table class="stats" style="margin-top: 8px;">
          <caption>Tabla 5.3: Balanza Comercial por Subsector SCIAN (Cifras 2024 en Miles USD)</caption>
          <thead>
            <tr><th>Subsector SCIAN</th><th>Importaciones (I)</th><th>Exportaciones (E)</th><th>Balanza (E - I)</th><th>Factor de Riesgo</th></tr>
          </thead>
          <tbody>
            <tr><td>313 - Fabricación de insumos textiles y acabado de textiles</td><td>1,180,515</td><td>810,395</td><td class="negative">–370,120</td><td>Déficit Crítico de Insumos</td></tr>
            <tr><td>314 - Fabricación de productos textiles, excepto prendas de vestir</td><td>1,542,439</td><td>725,032</td><td class="negative">–817,407</td><td>Brecha de Textil Intermedio</td></tr>
            <tr><td>315 - Fabricación de prendas de vestir</td><td>1,960,358</td><td>2,726,073</td><td class="positive">+765,715</td><td>Superávit Consistente (Confección)</td></tr>
          </tbody>
        </table>
      </div>
      
      <div style="margin-top:18px; border-top: 1px solid #eee; padding-top: 12px;">
        <h2>Estructura Geográfica, Composición y Riesgos de Dependencia</h2>
        <p class="chart-context">
          La Secretaría de Economía, a través del Sistema de Información Arancelaria Vía Internet (SIAVI), reúne y publica información detallada sobre el comercio exterior de México, incluyendo los valores de importación y exportación por país, fracción arancelaria y sector productivo. Este sistema integra datos oficiales de las operaciones registradas en la aduana y permite identificar los principales orígenes de las importaciones de la ITC con base en montos y participaciones acumuladas. Con esta información es posible analizar la estructura geográfica del comercio del sector y los riesgos asociados a la concentración de proveedores, revelando dos características estructurales del sector: la dependencia de EUA como cliente y la concentración de la presión en países asiáticos.
        </p>
        <h3 style="font-size: 14px; color: var(--primary-color);">Análisis Estructural (Resumen):</h3>
        <ul class="intro-text" style="margin-top:0; padding-left: 20px;">
          <li>
            <strong>Dependencia Exportadora de EUA:</strong> Estados Unidos consolida su posición como destino hegemónico, absorbiendo consistentemente entre el 84% y el 91% de las exportaciones totales mexicanas de textiles y confección. Esta dependencia subraya la importancia crítica del mercado norteamericano y la necesidad de mantener la ventaja competitiva derivada del T-MEC, lo cual hace imperativa una revisión de la política arancelaria sobre insumos para no dañar los márgenes de los exportadores.
          </li>
          <li>
            <strong>Concentración de Origen de Importación:</strong> La presión competitiva se origina principalmente en China, Estados Unidos, Vietnam y Bangladés, países que en conjunto concentran el 65% al 67% del valor total importado. Estos orígenes, especialmente los asiáticos, son los objetivos primarios de las medidas de protección y fiscalización.
          </li>
        </ul>
        <div class="flex-container" style="margin-top: 12px; align-items: flex-start; gap: 24px;">
          <div style="flex: 1.2;">
            <table class="stats" style="margin-top: 8px;">
              <caption>Tabla 5.6: Concentración Geográfica del Comercio Exterior de la ITC (2024 - Cifras Acumuladas)</caption>
              <thead>
                <tr><th>Flujo Comercial</th><th>País/Región</th><th>Valor Acumulado (Millones de USD)</th><th>Participación (%)</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td rowspan="3">Exportaciones (Destino)</td>
                  <td>Estados Unidos (EUA)</td><td>7,414</td><td>~91%</td>
                </tr>
                <tr><td>Otros Países</td><td>699</td><td>~9%</td></tr>
                <tr><td><strong>TOTAL Exportaciones</strong></td><td><strong>8,113</strong></td><td><strong>100%</strong></td></tr>
                <tr>
                  <td rowspan="6">Importaciones (Origen)</td>
                  <td>China</td><td>5,407</td><td>~36%</td>
                </tr>
                <tr><td>Estados Unidos (EUA)</td><td>3,413</td><td>~23%</td></tr>
                <tr><td>Vietnam</td><td>977</td><td>~7%</td></tr>
                <tr><td>Bangladés</td><td>649</td><td>~4%</td></tr>
                <tr><td>Otros Países</td><td>4,554</td><td>~30%</td></tr>
                <tr><td><strong>TOTAL Importaciones</strong></td><td><strong>15,000</strong></td><td><strong>100%</strong></td></tr>
              </tbody>
            </table>
            <p class="note" style="text-align: right; margin-top: 4px;">Fuente: Secretaría de Economía, Sistema de Información Arancelaria Vía Internet (SIAVI). Elaboración propia con datos consolidados del periodo 2020-2024.</p>
          </div>
          <div style="flex: 1; display: flex; flex-direction: column; gap: 18px;">
            <h3>Destino de Exportaciones (2024)</h3>
            <div class="chart" id="chart-geo-exports" style="height:120px"></div>
            
            <h3>Origen de Importaciones (2024)</h3>
            <div class="chart" id="chart-geo-imports" style="height:200px"></div>
          </div>
        </div>
      </div>
      
      <div class="flex-container" style="margin-top:12px">
        <div>
          <h3>Origen de las importaciones (Acumulado 2020–2024)</h3>
          <p class="chart-context">
            La tendencia de las importaciones totales (2020 Q1 - 2025 Q3) refleja la dependencia estructural de la ITC hacia insumos externos. Las importaciones superan consistentemente a las exportaciones en volumen, lo que se traduce en el déficit comercial observado. El <strong>subsector SCIAN 313 (Insumos textiles)</strong> es el que más contribuye a este volumen de importaciones, evidenciando un cuello de botella en la producción nacional de materia prima e intermedios.
          </p>
          <div class="chart" id="chart-origin" style="height:250px; margin-bottom: 8px;"></div>
          <div class="legend" id="legend-origin"></div>
          <table class="stats" style="margin-top:8px;">
            <thead><tr><th>País</th><th>Monto (MM USD)</th><th>Participación</th></tr></thead>
            <tbody>
              <tr><td>China</td><td>18,500</td><td>38.5%</td></tr>
              <tr><td>Estados Unidos</td><td>12,100</td><td>25.2%</td></tr>
              <tr><td>Vietnam</td><td>3,850</td><td>8.0%</td></tr>
              <tr><td>India</td><td>1,550</td><td>3.2%</td></tr>
              <tr><td>Bangladés</td><td>1,350</td><td>2.8%</td></tr>
              <tr><td>Otros</td><td>10,700</td><td>22.3%</td></tr>
            </tbody>
          </table>
        </div>

        <div>
          <h3>Destinos de exportación (Acumulado 2020–2024)</h3>
          <p class="chart-context">
            Las exportaciones totales de la ITC (2020 Q1 - 2025 Q3) muestran una tendencia de crecimiento notable, especialmente después de 2021. Este desempeño se debe en gran medida a la robusta actividad del <strong>subsector SCIAN 315 (Fabricación de prendas de vestir)</strong>, que funciona como un motor clave de las exportaciones, representando la etapa final y de mayor valor añadido en la cadena productiva. La demanda sostenida del mercado estadounidense ha sido el principal factor impulsor.
          </p>
          <div class="chart" id="chart-dest" style="height:250px; margin-bottom: 8px;"></div>
          <div class="legend" id="legend-dest"></div>
          <table class="stats" style="margin-top:8px;">
            <thead><tr><th>País</th><th>Monto (MM USD)</th><th>Participación</th></tr></thead>
            <tbody>
              <tr><td>Estados Unidos</td><td>10,900</td><td>89.5%</td></tr>
              <tr><td>Canadá</td><td>450</td><td>3.7%</td></tr>
              <tr><td>Guatemala</td><td>220</td><td>1.8%</td></tr>
              <tr><td>Colombia</td><td>110</td><td>0.9%</td></tr>
              <tr><td>Honduras</td><td>80</td><td>0.7%</td></tr>
              <tr><td>Otros</td><td>410</td><td>3.4%</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section style="margin-top:12px" class="card">
      <h2>Empresas exportadoras / importadoras (2020–2024)</h2>
      <p class="chart-context">
        El análisis del número de empresas participantes en el comercio exterior (2020-2024) revela una tendencia a la consolidación. Se observa una disminución gradual en la cantidad de firmas tanto exportadoras como importadoras, especialmente en el subsector <strong>SCIAN 315 (Prendas de vestir)</strong>. Esto sugiere que, si bien el volumen de comercio puede crecer, este se concentra en un número menor de actores, posiblemente de mayor tamaño y eficiencia.
      </p>
      <div class="grid">
        <div class="card">
          <h3>Empresas Exportadoras (E)</h3>
          <div class="chart" id="chart-firms-e" style="height:280px"></div>
          <div class="legend">
            <span><i class="swatch" style="background:#1E5B4F"></i>313</span>
            <span><i class="swatch" style="background:#A6802D"></i>314</span>
            <span><i class="swatch" style="background:#9C2348"></i>315</span>
          </div>
          <table class="stats" style="margin-top:8px;overflow:auto">
            <thead><tr><th>SCIAN</th><th>2020</th><th>2021</th><th>2022</th><th>2023</th><th>2024</th></tr></thead>
            <tbody>
              <tr><td>313</td><td>121</td><td>118</td><td>108</td><td>103</td><td>101</td></tr>
              <tr><td>314</td><td>86</td><td>90</td><td>87</td><td>85</td><td>80</td></tr>
              <tr><td>315</td><td>286</td><td>275</td><td>266</td><td>264</td><td>228</td></tr>
            </tbody>
          </table>
        </div>
        <div class="card">
          <h3>Empresas Importadoras (I)</h3>
          <div class="chart" id="chart-firms-i" style="height:280px"></div>
          <div class="legend">
            <span><i class="swatch" style="background:#1E5B4F"></i>313</span>
            <span><i class="swatch" style="background:#A6802D"></i>314</span>
            <span><i class="swatch" style="background:#9C2348"></i>315</span>
          </div>
          <table class="stats" style="margin-top:8px;overflow:auto">
            <thead><tr><th>SCIAN</th><th>2020</th><th>2021</th><th>2022</th><th>2023</th><th>2024</th></tr></thead>
            <tbody>
              <tr><td>313</td><td>153</td><td>153</td><td>149</td><td>142</td><td>142</td></tr>
              <tr><td>314</td><td>104</td><td>109</td><td>107</td><td>113</td><td>105</td></tr>
              <tr><td>315</td><td>303</td><td>302</td><td>292</td><td>275</td><td>251</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <footer>
      <div>Documento generado para el Anexo I — Nota Informativa y Resultados del Análisis de la ITC.</div>
    </footer>
  </div>

  <!-- Contenedor para el tooltip -->
  <div id="chart-tooltip"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      /* ===== Análisis de Causa Raíz y Solución =====
         Causa Raíz:
         1.  Uso de variables CSS en atributos SVG: El código intentaba asignar colores a los elementos SVG usando `var(--primary-color)`. La mayoría de los navegadores no resuelven estas variables CSS cuando se usan en atributos SVG a través de JavaScript, resultando en colores inválidos y gráficos invisibles.
         2.  Llamada a función faltante: El gráfico para 'chart-ied' no se dibujaba porque faltaba la llamada a la función `drawLineChart` correspondiente.

         Solución Implementada:
         -   Se definen los colores como constantes de JavaScript (`COLOR_PRIMARY`, etc.) con sus valores hexadecimales.
         -   Estas constantes se usan para definir los colores en los objetos de datos de los gráficos.
         -   Se añade la llamada a `drawLineChart('chart-ied', ied)` para renderizar el gráfico que faltaba.
      */
      var COLOR_PRIMARY = '#1E5B4F';
      var COLOR_SECONDARY = '#A6802D';
      var COLOR_ACCENT = '#9C2348';
      var COLORS_PIE = [COLOR_PRIMARY, COLOR_SECONDARY, COLOR_ACCENT, '#7f8c8d', '#c0392b', '#f1c40f'];

      // --- Tooltip Global ---
      var tooltip = document.getElementById('chart-tooltip');
      document.addEventListener('mousemove', function(e) {
        if (tooltip.style.display === 'block') {
          tooltip.style.left = (e.pageX + 15) + 'px';
          tooltip.style.top = (e.pageY + 15) + 'px';
        }
      });

    var pib = {
      years:['2018','2019','2020','2021','2022','2023','2024','2025 Sep'],
      series:[
        {name:'313', color:COLOR_PRIMARY, values:[100,101.1,104.2,109.6,122.5,122.1,123.6,126.0]},
        {name:'314', color:COLOR_SECONDARY, values:[100,102.4,105.5,113.7,119.9,122.7,125.5,127.8]},
        {name:'315', color:COLOR_ACCENT, values:[100,105.3,110.2,118.5,130.3,126.8,130.1,135.5]}
      ]
    };

    var ied = {
      years:['2019','2020','2021','2022','2023','2024','Mar 2025'],
      series:[
        {name:'313', color:COLOR_PRIMARY, values:[2.4,1.0,37.1,24.6,10.2,4.8,-5.8]},
        {name:'314', color:COLOR_SECONDARY, values:[23.1,18.2,19.4,31.7,17.3,64.0,2.3]},
        {name:'315', color:COLOR_ACCENT, values:[76.3,23.2,8.0,62.5,-4.5,51.0,13.3]}
      ]
    };

    var trade = {
      labels:['Cierre parcial 2024','Coyuntura 2025 (Ene-Sep)'],
      imports:[12394,9874],
      exports:[8114,5561]
    };

    var prodVal = {
      labels:['313','314','315','Total'],
      production:[467012975,186428225,545603398,1199044598],
      sales:[457989155,185327239,542193414,1185559808]
    };

    var prodQty = {
      labels:['313','314','315','Total'],
      production:[4492568,303663003,688381603,996537174],
      sales:[4400535,296722051,670934639,972057225]
    };

    var balanceSub = {labels:['313','314','315'], imports:[1180515,1542439,1960358], exports:[810395,725032,2726073]};

    var origins = [{label:'China',value:18500},{label:'USA',value:12100},{label:'Vietnam',value:3850},{label:'India',value:1550},{label:'Bangladés',value:1350},{label:'Otros',value:10700}];
    var dest = [{label:'Estados Unidos',value:10900},{label:'Canadá',value:450},{label:'Guatemala',value:220},{label:'Colombia',value:110},{label:'Honduras',value:80},{label:'Otros',value:410}];

    var firmsE = {
      years:['2020','2021','2022','2023','2024'],
      series:[
        {name:'313', color: '#1E5B4F', vals:[121,118,108,103,101]},
        {name:'314', color: '#A6802D', vals:[86,90,87,85,80]},
        {name:'315', color: '#9C2348', vals:[286,275,266,264,228]}
      ]
    };

    var firmsI = {
        years: ['2020', '2021', '2022', '2023', '2024'],
        series: [
            { name: '313', color: '#1E5B4F', vals: [153, 153, 149, 142, 142] },
            { name: '314', color: '#A6802D', vals: [104, 109, 107, 113, 105] },
            { name: '315', color: '#9C2348', vals: [303, 302, 292, 275, 251] }
        ]
    };

    var iedManufacturas = {
      years: ['2020', '2021', '2022', '2023', '2024', '2025'],
      series: [
        { name: 'Manufacturas (Total)', color: COLOR_PRIMARY, values: [11625.2, 14575.4, 14040.1, 18148.1, 19884.7, 9237.1] },
        { name: 'Comercio al por mayor - Textiles y Calzado', color: COLOR_SECONDARY, values: [9.3, -17.4, 51.8, 227.9, 9.4, -5.3] },
        { name: 'Comercio al por menor - Textiles, accesorios y calzado', color: COLOR_ACCENT, values: [19.4, 10.7, 5.3, 35.6, -28.7, 0.0] }
      ]
    };

    var iedManufacturasDual = {
      years: ['2020', '2021', '2022', '2023', '2024', '2025'],
      leftSeries: [
        { name: 'Manufacturas (Total)', color: COLOR_PRIMARY, values: [11625.2, 14575.4, 14040.1, 18148.1, 19884.7, 9237.1] }
      ],
      rightSeries: [
        { name: 'Comercio al por mayor - Textiles y Calzado', color: COLOR_SECONDARY, values: [9.3, -17.4, 51.8, 227.9, 9.4, -5.3] },
        { name: 'Comercio al por menor - Textiles, accesorios y calzado', color: COLOR_ACCENT, values: [19.4, 10.7, 5.3, 35.6, -28.7, 0.0] }
      ]
    };

    var balanceHistoric = {
      years: ['2020', '2021', '2022', '2023', '2024'],
      series: [
        { name: 'Exportaciones', color: COLOR_SECONDARY, values: [3974570, 4635633, 5291623, 4653517, 4261490] },
        { name: 'Importaciones', color: COLOR_PRIMARY, values: [2819939, 4104880, 4840429, 4778131, 4683277] },
        { name: 'Balanza', color: COLOR_ACCENT, values: [1154631, 530753, 451194, -124614, -421787] }
      ]
    };

    var balanceSubsector2024 = {
      labels: ['313', '314', '315'],
      imports: [1180515, 1542439, 1960358],
      exports: [810395, 725032, 2726073],
      balance: [-370120, -817407, 765715]
    };
    
    var geoExportsData = [
      { label: 'Estados Unidos (EUA)', value: 7414 },
      { label: 'Otros Países', value: 699 }
    ];

    function drawHorizontalBarChart(containerId, data, color) {
        var c = document.getElementById(containerId);
        if (!c) return;
        var w = Math.max(100, c.clientWidth) || 400;
        var h = c.clientHeight || 200;
        var p = { top: 10, right: 20, bottom: 20, left: 120 }; // Padding para etiquetas
        var svg = createSVG(w, h);

        var maxVal = Math.max.apply(null, data.map(d => d.value));
        var barHeight = (h - p.top - p.bottom) / data.length * 0.7;
        var barSpacing = (h - p.top - p.bottom) / data.length * 0.3;

        for (var i = 0; i < data.length; i++) {
            var d = data[i];
            var barY = p.top + i * (barHeight + barSpacing);
            var barWidth = (d.value / maxVal) * (w - p.left - p.right);

            // Etiqueta del país
            var label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', p.left - 10);
            label.setAttribute('y', barY + barHeight / 2 + 4);
            label.setAttribute('font-size', 11);
            label.setAttribute('text-anchor', 'end');
            label.setAttribute('fill', '#333');
            label.textContent = d.label;
            svg.appendChild(label);

            // Barra
            var tooltipText = d.label + ': ' + d.value.toLocaleString() + ' MM USD';
            var bar = createBar(p.left, barY, barWidth, barHeight, color, tooltipText);
            svg.appendChild(bar);

            // Etiqueta de valor dentro o fuera de la barra
            var valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            var valueX = p.left + barWidth + 5;
            var valueAnchor = 'start';
            var valueFill = '#333';
            if (barWidth > 80) { // Si la barra es suficientemente ancha, poner el texto adentro
                valueX = p.left + barWidth - 5;
                valueAnchor = 'end';
                valueFill = 'white';
            }
            valueLabel.setAttribute('x', valueX);
            valueLabel.setAttribute('y', barY + barHeight / 2 + 4);
            valueLabel.setAttribute('font-size', 10);
            valueLabel.setAttribute('font-weight', 'bold');
            valueLabel.setAttribute('text-anchor', valueAnchor);
            valueLabel.setAttribute('fill', valueFill);
            valueLabel.textContent = d.value.toLocaleString();
            svg.appendChild(valueLabel);
        }
        c.appendChild(svg);
    }

    var geoImportsData = [
      { label: 'China', value: 5407 }, { label: 'Estados Unidos (EUA)', value: 3413 },
      { label: 'Vietnam', value: 977 }, { label: 'Bangladés', value: 649 }, { label: 'Otros Países', value: 4554 }
    ];

    function createSVG(w,h){
      var svgNS = 'http://www.w3.org/2000/svg';
      var svg = document.createElementNS(svgNS,'svg');
      svg.setAttribute('viewBox','0 0 ' + w + ' ' + h);
      svg.setAttribute('width','100%');
      svg.setAttribute('height','100%');
      // ensure readable text by default
      svg.setAttribute('style','font-family:Arial,Helvetica,sans-serif');
      return svg;
    }

    function drawLineChart(containerId, data){
      var c = document.getElementById(containerId);
      if(!c) return;
      var w = Math.max(100, c.clientWidth) || 460;
      var h = c.clientHeight || 220;
      var p = { top: 20, right: 20, bottom: 40, left: 40 }; // Aumentamos el padding inferior
      var svg = createSVG(w,h);

      var allVals = [];
      for(var i=0;i<data.series.length;i++) allVals = allVals.concat(data.series[i].values);
      var maxVal = Math.ceil(Math.max.apply(null, allVals) / 10) * 10;
      var minVal = Math.floor(Math.min.apply(null, allVals) / 10) * 10;
      if (minVal > 0) minVal = 0; // Start axis at 0 if all values are positive
      if(!isFinite(maxVal)) maxVal = 1;
      if(!isFinite(minVal)) minVal = 0;

      var xStep = (w - p.left - p.right) / Math.max(1, (data.years.length - 1));
      var yRange = maxVal - minVal || 1;

      // Draw Y-axis grid lines and labels
      var numGridLines = 5;
      for (var i = 0; i <= numGridLines; i++) {
        var val = minVal + (yRange / numGridLines) * i;
        var y = p.top + (h - p.top - p.bottom) * (1 - (val - minVal) / yRange);
        var line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', p.left);
        line.setAttribute('y1', y);
        line.setAttribute('x2', w - p.right);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#eee');
        svg.appendChild(line);

        var text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', p.left - 8);
        text.setAttribute('y', y + 3);
        text.setAttribute('font-size', 10);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('fill', '#666');
        text.textContent = val.toFixed(0);
        svg.appendChild(text);
      }

      // Draw series lines and points
      for(var si=0; si<data.series.length; si++){
        var s = data.series[si];
        var pointsArr = [];
        for(var i=0;i<s.values.length;i++){
          var v = s.values[i] || 0;
          var x = p.left + i * xStep;
          var y = p.top + (h - p.top - p.bottom) * (1 - (v - minVal) / yRange);
          pointsArr.push(x + ',' + y);
        }
        var poly = document.createElementNS('http://www.w3.org/2000/svg','polyline');
        poly.setAttribute('points', pointsArr.join(' '));
        poly.setAttribute('fill','none');
        poly.setAttribute('stroke', s.color || COLOR_PRIMARY);
        poly.setAttribute('stroke-width', 2.5);
        poly.setAttribute('stroke-linejoin', 'round');
        poly.setAttribute('stroke-linecap', 'round');
        svg.appendChild(poly);

        // Draw interactive points
        for(var i=0;i<s.values.length;i++){
          var v = s.values[i] || 0;
          var x = p.left + i * xStep;
          var y = p.top + (h - p.top - p.bottom) * (1 - (v - minVal) / yRange);
          
          var circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
          circle.setAttribute('cx', x);
          circle.setAttribute('cy', y);
          circle.setAttribute('r', 4);
          circle.setAttribute('fill', s.color);
          circle.setAttribute('stroke', 'white');
          circle.setAttribute('stroke-width', 2);
          circle.style.transition = 'r 0.2s';
          svg.appendChild(circle);

          var hitArea = document.createElementNS('http://www.w3.org/2000/svg','circle');
          hitArea.setAttribute('cx', x);
          hitArea.setAttribute('cy', y);
          hitArea.setAttribute('r', 10);
          hitArea.setAttribute('fill', 'transparent');
          hitArea.style.cursor = 'pointer';
          
          (function(year, seriesName, value, pointCircle){
            hitArea.addEventListener('mouseover', function(){
              tooltip.innerHTML = 'Año: ' + year + '\nSerie: ' + seriesName + '\nValor: ' + value;
              tooltip.style.display = 'block';
              pointCircle.setAttribute('r', 6);
            });
            hitArea.addEventListener('mouseout', function(){
              tooltip.style.display = 'none';
              pointCircle.setAttribute('r', 4);
            });
          })(data.years[i], s.name, v, circle);

          svg.appendChild(hitArea);
        }
      }

      // Draw X-axis labels
      for(var i=0;i<data.years.length;i++){
        var x = p.left + i * xStep;
        var t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', x);
        t.setAttribute('y', h - p.bottom + 15);
        t.setAttribute('font-size',11);
        t.setAttribute('text-anchor','middle');
        t.setAttribute('fill','#111');
        t.textContent = data.years[i];
        svg.appendChild(t);
      }

      c.appendChild(svg);
    }

    function drawDualAxisLineChart(containerId, data) {
      var c = document.getElementById(containerId);
      if (!c) return;
      var w = Math.max(100, c.clientWidth) || 460;
      var h = c.clientHeight || 220;
      var p = { top: 20, right: 40, bottom: 40, left: 50 }; // Ajustar paddings para ejes
      var svg = createSVG(w, h);

      // --- Eje Izquierdo (leftSeries) ---
      var leftVals = data.leftSeries.flatMap(s => s.values);
      var maxLeft = Math.ceil(Math.max.apply(null, leftVals) / 1000) * 1000;
      var minLeft = 0; // Forzar inicio en 0
      var yRangeLeft = maxLeft - minLeft || 1;

      // --- Eje Derecho (rightSeries) ---
      var rightVals = data.rightSeries.flatMap(s => s.values);
      var maxRight = Math.ceil(Math.max.apply(null, rightVals) / 10) * 10;
      var minRight = Math.floor(Math.min.apply(null, rightVals) / 10) * 10;
      var yRangeRight = maxRight - minRight || 1;

      var xStep = (w - p.left - p.right) / Math.max(1, (data.years.length - 1));

      // Dibujar rejilla y etiquetas del eje Y izquierdo
      var numGridLines = 5;
      for (var i = 0; i <= numGridLines; i++) {
        var val = minLeft + (yRangeLeft / numGridLines) * i;
        var y = p.top + (h - p.top - p.bottom) * (1 - (val - minLeft) / yRangeLeft);
        var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', p.left);
        line.setAttribute('y1', y);
        line.setAttribute('x2', w - p.right);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#eee');
        svg.appendChild(line);

        var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', p.left - 8);
        text.setAttribute('y', y + 3);
        text.setAttribute('font-size', 10);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('fill', '#666');
        text.textContent = (val / 1000).toFixed(0) + 'k'; // Formato en miles
        svg.appendChild(text);
      }

      // Dibujar etiquetas del eje Y derecho
      for (var i = 0; i <= numGridLines; i++) {
        var val = minRight + (yRangeRight / numGridLines) * i;
        var y = p.top + (h - p.top - p.bottom) * (1 - (val - minRight) / yRangeRight);
        var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', w - p.right + 8);
        text.setAttribute('y', y + 3);
        text.setAttribute('font-size', 10);
        text.setAttribute('text-anchor', 'start');
        text.setAttribute('fill', '#666');
        text.textContent = val.toFixed(0);
        svg.appendChild(text);
      }

      // Función para dibujar una serie
      function drawSeries(series, yMin, yRange) {
        series.forEach(s => {
          var pointsArr = [];
          for (var i = 0; i < s.values.length; i++) {
            var v = s.values[i] || 0;
            var x = p.left + i * xStep;
            var y = p.top + (h - p.top - p.bottom) * (1 - (v - yMin) / yRange);
            pointsArr.push(x + ',' + y);
          }
          var poly = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
          poly.setAttribute('points', pointsArr.join(' '));
          poly.setAttribute('fill', 'none');
          poly.setAttribute('stroke', s.color || COLOR_PRIMARY);
          poly.setAttribute('stroke-width', 2.5);
          poly.setAttribute('stroke-linejoin', 'round');
          poly.setAttribute('stroke-linecap', 'round');
          svg.appendChild(poly);

          // Puntos interactivos
          for (var i = 0; i < s.values.length; i++) {
            var v = s.values[i] || 0;
            var x = p.left + i * xStep;
            var y = p.top + (h - p.top - p.bottom) * (1 - (v - yMin) / yRange);

            var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', 4);
            circle.setAttribute('fill', s.color);
            circle.setAttribute('stroke', 'white');
            circle.setAttribute('stroke-width', 2);
            circle.style.transition = 'r 0.2s';
            svg.appendChild(circle);

            var hitArea = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            hitArea.setAttribute('cx', x);
            hitArea.setAttribute('cy', y);
            hitArea.setAttribute('r', 10);
            hitArea.setAttribute('fill', 'transparent');
            hitArea.style.cursor = 'pointer';

            (function(year, seriesName, value, pointCircle) {
              hitArea.addEventListener('mouseover', function() {
                tooltip.innerHTML = 'Año: ' + year + '\nSerie: ' + seriesName + '\nValor: ' + value.toLocaleString();
                tooltip.style.display = 'block';
                pointCircle.setAttribute('r', 6);
              });
              hitArea.addEventListener('mouseout', function() {
                tooltip.style.display = 'none';
                pointCircle.setAttribute('r', 4);
              });
            })(data.years[i], s.name, v, circle);

            svg.appendChild(hitArea);
          }
        });
      }

      // Dibujar series
      drawSeries(data.leftSeries, minLeft, yRangeLeft);
      drawSeries(data.rightSeries, minRight, yRangeRight);

      // Dibujar etiquetas del eje X
      for (var i = 0; i < data.years.length; i++) {
        var x = p.left + i * xStep;
        var t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        t.setAttribute('x', x);
        t.setAttribute('y', h - p.bottom + 15);
        t.setAttribute('font-size', 11);
        t.setAttribute('text-anchor', 'middle');
        t.setAttribute('fill', '#111');
        t.textContent = data.years[i];
        svg.appendChild(t);
      }

      c.appendChild(svg);
    }


    function drawStackedBars(containerId, labels, importsArr, exportsArr){
      var c = document.getElementById(containerId);
      if(!c) return;
      var w = Math.max(100, c.clientWidth) || 460;
      var h = c.clientHeight || 220;
      var p = { top: 20, right: 20, bottom: 40, left: 40 };
      var svg = createSVG(w,h);

      var combined = importsArr.concat(exportsArr);
      var maxVal = Math.ceil(Math.max.apply(null, combined) / 1000) * 1000;
      if(!isFinite(maxVal) || maxVal===0) maxVal = 1;

      var barGroupWidth = (w - p.left - p.right) / labels.length;
      var barWidth = barGroupWidth * 0.35;

      // Draw Y-axis grid lines
      var numGridLines = 4;
      for (var i = 0; i <= numGridLines; i++) {
        var y = p.top + (h - p.top - p.bottom) / numGridLines * i;
        var line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', p.left);
        line.setAttribute('y1', y);
        line.setAttribute('x2', w - p.right);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#eee');
        svg.appendChild(line);
        var val = maxVal * (1 - i / numGridLines);
        var text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', p.left - 8);
        text.setAttribute('y', y + 3);
        text.setAttribute('font-size', 10);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('fill', '#666');
        text.textContent = (val/1000).toFixed(0) + 'k';
        svg.appendChild(text);
      }

      for(var i=0;i<labels.length;i++){
        var groupX = p.left + i * barGroupWidth;
        var barSpacing = (barGroupWidth - (barWidth * 2)) / 3;
        var x1 = groupX + barSpacing;
        var x2 = x1 + barWidth + barSpacing;

        var impH = (importsArr[i]/maxVal)*(h-p.top-p.bottom);
        var expH = (exportsArr[i]/maxVal)*(h-p.top-p.bottom);
        
        var rect1 = createBar(x1, h - p.bottom - impH, barWidth, impH, COLOR_PRIMARY, 'Importaciones: ' + importsArr[i].toLocaleString());
        var rect2 = createBar(x2, h - p.bottom - expH, barWidth, expH, COLOR_SECONDARY, 'Exportaciones: ' + exportsArr[i].toLocaleString());
        
        // --- INICIO DE LA MODIFICACIÓN ---
        // Añadir etiqueta de déficit si el ID del contenedor es 'chart-trade'
        if (containerId === 'chart-trade') {
            var deficit = importsArr[i] - exportsArr[i];
            var dlabel = document.createElementNS('http://www.w3.org/2000/svg','text');
            dlabel.setAttribute('x', x2);
            dlabel.setAttribute('y', h - p.bottom - Math.max(impH, expH) - 8);
            dlabel.setAttribute('font-size', 11);
            dlabel.setAttribute('text-anchor', 'middle');
            dlabel.setAttribute('fill', COLOR_ACCENT);
            dlabel.setAttribute('font-weight', 'bold');
            dlabel.textContent = 'Déficit: ' + deficit.toLocaleString();
            svg.appendChild(dlabel);
        }
        // --- FIN DE LA MODIFICACIÓN ---

        svg.appendChild(rect1);
        svg.appendChild(rect2);

        var labt = document.createElementNS('http://www.w3.org/2000/svg','text');
        labt.setAttribute('x', x1 + barWidth + barSpacing/2);
        labt.setAttribute('y',h - p.bottom + 15);
        labt.setAttribute('font-size',11);
        labt.setAttribute('text-anchor','middle');
        labt.setAttribute('fill','#111');
        labt.textContent = labels[i];
        svg.appendChild(labt);
      }
      c.appendChild(svg);
    }

    function createBar(x, y, w, h, fill, tooltipText) {
      var rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', x);
      rect.setAttribute('y', y);
      rect.setAttribute('width', w);
      rect.setAttribute('height', h);
      rect.setAttribute('fill', fill);
      rect.setAttribute('rx', 2); // Rounded corners
      rect.style.transition = 'opacity 0.2s';

      rect.addEventListener('mouseover', function() {
        tooltip.innerHTML = tooltipText;
        tooltip.style.display = 'block';
        rect.style.opacity = 0.8;
      });
      rect.addEventListener('mouseout', function() {
        tooltip.style.display = 'none';
        rect.style.opacity = 1;
      });
      return rect;
    }

    function drawSignedBarChart(containerId, data) {
      var c = document.getElementById(containerId);
      if (!c) return;
      var w = Math.max(100, c.clientWidth) || 460;
      var h = c.clientHeight || 220;
      var p = { top: 20, right: 20, bottom: 30, left: 50 };
      var svg = createSVG(w, h);

      var allVals = data.imports.concat(data.exports).concat(data.balance);
      var maxVal = Math.max.apply(null, allVals);
      var minVal = Math.min.apply(null, allVals);
      
      var yRange = maxVal - minVal;
      var zeroY = h - p.bottom - (Math.abs(minVal) / yRange) * (h - p.top - p.bottom);

      var groupWidth = (w - p.left - p.right) / data.labels.length;
      var barWidth = groupWidth * 0.25;
      var barMargin = (groupWidth - (3 * barWidth)) / 4;

      // Draw Y-axis grid and zero line
      var numGridLines = 6;
      for (var i = 0; i <= numGridLines; i++) {
        var val = minVal + (yRange / numGridLines) * i;
        var y = p.top + (h - p.top - p.bottom) * (1 - (val - minVal) / yRange);
        var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', p.left);
        line.setAttribute('y1', y);
        line.setAttribute('x2', w - p.right);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#eee');
        svg.appendChild(line);

        var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', p.left - 8);
        text.setAttribute('y', y + 3);
        text.setAttribute('font-size', 10);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('fill', '#666');
        text.textContent = (val / 1000000).toFixed(1) + 'M';
        svg.appendChild(text);
      }
      var zeroLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      zeroLine.setAttribute('x1', p.left);
      zeroLine.setAttribute('y1', zeroY);
      zeroLine.setAttribute('x2', w - p.right);
      zeroLine.setAttribute('y2', zeroY);
      zeroLine.setAttribute('stroke', '#999');
      zeroLine.setAttribute('stroke-width', '1');
      svg.appendChild(zeroLine);

      // Draw bars
      for (var i = 0; i < data.labels.length; i++) {
        var groupX = p.left + i * groupWidth;
        
        // Imports
        var impVal = data.imports[i];
        var impH = (impVal / yRange) * (h - p.top - p.bottom);
        var impX = groupX + barMargin;
        var impY = zeroY - impH;
        svg.appendChild(createBar(impX, impY, barWidth, impH, COLOR_PRIMARY, 'Importaciones: ' + impVal.toLocaleString()));

        // Exports
        var expVal = data.exports[i];
        var expH = (expVal / yRange) * (h - p.top - p.bottom);
        var expX = impX + barWidth + barMargin;
        var expY = zeroY - expH;
        svg.appendChild(createBar(expX, expY, barWidth, expH, COLOR_SECONDARY, 'Exportaciones: ' + expVal.toLocaleString()));

        // Balance
        var balVal = data.balance[i];
        var balH = (Math.abs(balVal) / yRange) * (h - p.top - p.bottom);
        var balX = expX + barWidth + barMargin;
        var balY = balVal >= 0 ? zeroY - balH : zeroY;
        svg.appendChild(createBar(balX, balY, barWidth, balH, COLOR_ACCENT, 'Balanza: ' + balVal.toLocaleString()));

        // Añadir etiqueta de valor para la balanza
        var label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', balX + barWidth / 2);
        label.setAttribute('y', balY + (balVal >= 0 ? -5 : balH + 12)); // Posición arriba o abajo
        label.setAttribute('font-size', 10);
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('fill', '#333');
        label.setAttribute('font-weight', 'bold');
        label.textContent = (balVal / 1000).toFixed(0) + 'k';
        svg.appendChild(label);


        // X-axis labels
        var t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', groupX + groupWidth / 2);
        t.setAttribute('y', h - p.bottom + 15);
        t.setAttribute('font-size', 11);
        t.setAttribute('text-anchor', 'middle');
        t.setAttribute('fill', '#111');
        t.textContent = data.labels[i];
        svg.appendChild(t);
      }
      c.appendChild(svg);
    }

    function drawPie(containerId, legendContainerId, dataArr){
      var c = document.getElementById(containerId);
      if(!c) return;
      // Si clientWidth es 0 (p.ej. en un contenedor flex sin ancho definido), usar el alto como referencia para el ancho.
      var w = Math.max(100, c.clientWidth) || c.clientHeight || 460;
      var h = c.clientHeight||250;
      var r = Math.min(w,h)/2.3; // Pie más grande
      var cx = w/2;
      var cy = h/2;
      var svg = createSVG(w,h);
      var total = 0;
      for(var i=0;i<dataArr.length;i++) total += dataArr[i].value;
      if(total === 0) total = 1;
      
      var startAngle = -Math.PI/2;
      var legendHTML = '';
      for(var i=0;i<dataArr.length;i++){
        var d = dataArr[i];
        var angle = (d.value/total) * Math.PI*2;
        var endAngle = startAngle + angle;
        var x1 = cx + r*Math.cos(startAngle);
        var y1 = cy + r*Math.sin(startAngle);
        var x2 = cx + r*Math.cos(endAngle);
        var y2 = cy + r*Math.sin(endAngle);
        var large = angle > Math.PI ? 1:0;
        var color = COLORS_PIE[i % COLORS_PIE.length];
        var path = document.createElementNS('http://www.w3.org/2000/svg','path');
        var dAttr = 'M ' + cx + ' ' + cy + ' L ' + x1 + ' ' + y1 + ' A ' + r + ' ' + r + ' 0 ' + large + ' 1 ' + x2 + ' ' + y2 + ' Z';
        path.setAttribute('d',dAttr);
        path.setAttribute('fill', color);
        svg.appendChild(path);

        var percent = (d.value / total * 100).toFixed(1);
        legendHTML += '<span><i class="swatch" style="background:' + color + '"></i>' + d.label + ' ('+percent+'%)</span>';

        startAngle = endAngle;
      }
      var legendContainer = document.getElementById(legendContainerId);
      if(legendContainer) legendContainer.innerHTML = legendHTML;
      c.appendChild(svg);
    }

      // main charts
      drawLineChart('chart-pib',pib);
      drawLineChart('chart-ied-series',ied);
      drawLineChart('chart-ied', ied); // Se añade la llamada que faltaba para el gráfico pequeño de IED.
      drawLineChart('chart-balance-historic', balanceHistoric);
      drawSignedBarChart('chart-balance-subsector-2024', balanceSubsector2024);
      drawDualAxisLineChart('chart-ied-manufacturas', iedManufacturasDual);

      drawStackedBars('chart-trade',trade.labels,trade.imports,trade.exports);
      drawStackedBars('chart-prod-val',prodVal.labels,prodVal.production,prodVal.sales);
      drawStackedBars('chart-prod-qty',prodQty.labels,prodQty.production,prodQty.sales);

      (function(){
        var c = document.getElementById('chart-balance-sub');
        if(!c) return;
        var w = Math.max(100, c.clientWidth)||460;
        var h = c.clientHeight||140;
        var svg = createSVG(w,h);
        var combined = balanceSub.imports.concat(balanceSub.exports);
        var max = Math.max.apply(null, combined);
        if(!isFinite(max) || max===0) max = 1;
        var bw = (w-60)/balanceSub.labels.length*0.35;
        for(var i=0;i<balanceSub.labels.length;i++){
          var lab = balanceSub.labels[i];
          var x = 30 + i*((w-60)/balanceSub.labels.length);
          var impH = (balanceSub.imports[i]/max)*(h-40);
          var expH = (balanceSub.exports[i]/max)*(h-40);
          var rect1 = document.createElementNS('http://www.w3.org/2000/svg','rect');
          rect1.setAttribute('x',x);
          rect1.setAttribute('y',h-20-impH);
          rect1.setAttribute('width',bw);
          rect1.setAttribute('height',impH);
          rect1.setAttribute('fill', COLOR_PRIMARY);
          svg.appendChild(createBar(x, h-20-impH, bw, impH, COLOR_PRIMARY, 'Importaciones: ' + balanceSub.imports[i].toLocaleString()));
          var rect2 = document.createElementNS('http://www.w3.org/2000/svg','rect');
          rect2.setAttribute('x',x + bw + 6);
          rect2.setAttribute('y',h-20-expH);
          rect2.setAttribute('width',bw);
          rect2.setAttribute('height',expH);
          rect2.setAttribute('fill', COLOR_SECONDARY);

          // --- INICIO DE LA MODIFICACIÓN ---
          var deficit = balanceSub.exports[i] - balanceSub.imports[i];
          var dlabel = document.createElementNS('http://www.w3.org/2000/svg','text');
          dlabel.setAttribute('x', x + bw);
          dlabel.setAttribute('y', h - 20 - Math.max(impH, expH) - 8);
          dlabel.setAttribute('font-size', 10);
          dlabel.setAttribute('text-anchor', 'middle');
          dlabel.setAttribute('fill', COLOR_ACCENT);
          dlabel.setAttribute('font-weight', 'bold');
          dlabel.textContent = (deficit / 1000).toFixed(0) + 'k';
          svg.appendChild(dlabel);
          // --- FIN DE LA MODIFICACIÓN ---

          svg.appendChild(createBar(x + bw + 6, h-20-expH, bw, expH, COLOR_SECONDARY, 'Exportaciones: ' + balanceSub.exports[i].toLocaleString()));
          var t = document.createElementNS('http://www.w3.org/2000/svg','text');
          t.setAttribute('x', x + bw + 6);
          t.setAttribute('y', h - 4);
          t.setAttribute('font-size',11);
          t.setAttribute('text-anchor','middle');
          t.setAttribute('fill','#111');
          t.textContent = lab;
          svg.appendChild(t);
        }
        c.appendChild(svg);
      })();

      drawPie('chart-origin', 'legend-origin', origins);
      drawPie('chart-dest', 'legend-dest', dest);

      drawHorizontalBarChart('chart-geo-exports', geoExportsData, COLOR_SECONDARY);
      drawHorizontalBarChart('chart-geo-imports', geoImportsData, COLOR_PRIMARY);

      function drawFirmsChart(containerId, firmsData) {
        var c = document.getElementById(containerId);
        if(!c) return;
        var w = Math.max(100, c.clientWidth)||900;
        var h = c.clientHeight||280;
        var svg = createSVG(w,h);
        var p = { top: 20, right: 20, bottom: 30, left: 40 };

        let maxArr = [];
        for(var si=0;si<firmsData.series.length;si++) maxArr = maxArr.concat(firmsData.series[si].vals);
        var maxVal = Math.ceil(Math.max.apply(null,maxArr) / 50) * 50;

        var yearCount = firmsData.years.length;
        var seriesCount = firmsData.series.length;
        var groupWidth = (w - p.left - p.right) / yearCount;
        var barWidth = groupWidth * 0.2;
        var barMargin = groupWidth * 0.05;

        for(var i=0; i<yearCount; i++){
          var groupX = p.left + i * groupWidth;
          var startX = groupX + (groupWidth - (seriesCount * barWidth + (seriesCount - 1) * barMargin)) / 2;

          for(var si=0; si<seriesCount; si++){
            var s = firmsData.series[si];
            var val = s.vals[i];
            var barH = (val / maxVal) * (h - p.top - p.bottom);
            var x = startX + si * (barWidth + barMargin);
            var y = h - p.bottom - barH;
            
            var tooltipText = 'Año: ' + firmsData.years[i] + '\nSubsector: ' + s.name + '\nEmpresas: ' + val;
            var bar = createBar(x, y, barWidth, barH, s.color, tooltipText);
            svg.appendChild(bar);
          }

          // X-axis labels
          var x_label = groupX + groupWidth / 2;
          var t = document.createElementNS('http://www.w3.org/2000/svg','text');
          t.setAttribute('x',x_label);
          t.setAttribute('y',h - p.bottom + 15);
          t.setAttribute('font-size',11);
          t.setAttribute('text-anchor','middle');
          t.setAttribute('fill','#111');
          t.textContent = firmsData.years[i];
          svg.appendChild(t);
        }

        // Y-axis labels
        var numGridLines = 5;
        for (var i = 0; i <= numGridLines; i++) {
          var val = (maxVal / numGridLines) * i;
          var y_label = h - p.bottom - (val / maxVal) * (h - p.top - p.bottom);
          var text = document.createElementNS('http://www.w3.org/2000/svg','text');
          text.setAttribute('x', p.left - 8);
          text.setAttribute('y', y_label + 3);
          text.setAttribute('font-size', 10);
          text.setAttribute('text-anchor', 'end');
          text.setAttribute('fill', '#666');
          text.textContent = val.toFixed(0);
          svg.appendChild(text);
        }

        c.appendChild(svg);
      }
      drawFirmsChart('chart-firms-e', firmsE);
      drawFirmsChart('chart-firms-i', firmsI);
      (function(){
        var c = document.getElementById('chart-balance');
        if(!c) return;
        var w = Math.max(100, c.clientWidth)||420;
        var h = c.clientHeight||220;
        var svg = createSVG(w,h);
        var combined = trade.imports.concat(trade.exports);
        var maxVal = Math.ceil(Math.max.apply(null, combined) / 1000) * 1000;
        if(!isFinite(maxVal) || maxVal===0) maxVal = 1;
        
        var barGroupWidth = (w-80)/trade.labels.length;
        var bw = barGroupWidth * 0.3;

        for(var i=0;i<trade.labels.length;i++){
          var groupX = 40 + i*barGroupWidth;
          var x1 = groupX + (barGroupWidth - (bw*2 + 8))/2;
          var x2 = x1 + bw + 8;

          var impH = (trade.imports[i]/maxVal)*(h-80);
          var expH = (trade.exports[i]/maxVal)*(h-80);

          var rect1 = createBar(x1, h-40-impH, bw, impH, COLOR_PRIMARY, 'Importaciones: ' + trade.imports[i].toLocaleString());
          var rect2 = createBar(x2, h-40-expH, bw, expH, COLOR_SECONDARY, 'Exportaciones: ' + trade.exports[i].toLocaleString());
          svg.appendChild(rect1);
          svg.appendChild(rect2);

          var deficit = trade.imports[i]-trade.exports[i];
          var dlabel = document.createElementNS('http://www.w3.org/2000/svg','text');
          dlabel.setAttribute('x', x2 + bw/2);
          dlabel.setAttribute('y', h - 40 - Math.max(impH,expH) - 12);
          dlabel.setAttribute('font-size',11);
          dlabel.setAttribute('text-anchor','middle');
          dlabel.setAttribute('fill', COLOR_ACCENT);
          dlabel.setAttribute('font-weight', 'bold');
          dlabel.textContent = 'Déficit: ' + deficit.toLocaleString();
          svg.appendChild(dlabel);

          var labt = document.createElementNS('http://www.w3.org/2000/svg','text');
          labt.setAttribute('x', x1 + bw + 4);
          labt.setAttribute('y', h - 10);
          labt.setAttribute('font-size',11);
          labt.setAttribute('text-anchor','middle');
          labt.setAttribute('fill','#111');
          labt.textContent = trade.labels[i].replace(' (Ene-Sep)','');
          svg.appendChild(labt);
        }
        c.appendChild(svg);
      })();
    });
  </script>

</body>
</html>
