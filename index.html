<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Äî Evoluci√≥n Producci√≥n Textil (v4.1 ‚Äî Fix Totales + Donut)</title>
  <style>

    /* body { zoom: 75%; } /* Causa probable de problemas de interacci√≥n con gr√°ficas. Considera eliminar o reemplazar con transform: scale() o ajustar tama√±os base. */
    .dashboard-wrapper {
      transform: scale(0.75);
      transform-origin: top left;
      width: 133.33%; /* 100% / 0.75 */
    }
    
    :root{
      --primary-color:#1E5B4F; --secondary-color:#A6802D; --accent-color:#9C2348; /* Colores principales se mantienen */
      --bg:#f8f9fa; --card: #ffffff; --muted:#6c757d; --text:#212529; /* Paleta de colores clara */
    }

    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:linear-gradient(180deg, #f4f7f9, #e9edf2); color:var(--text); -webkit-font-smoothing:antialiased;}
    .container{ max-width:1320px; margin:16px auto; padding:16px; display:grid; gap:16px; grid-template-columns:1fr 360px; }
    header{ grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; gap:12px }
    h1{ margin:0; font-size:20px } p.lead{ margin:0; color:var(--muted); font-size:13px }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    select, button, input[type=number]{ background: linear-gradient(180deg, rgba(255,255,255,0.017), rgba(255,255,255,0.01)); color:var(--text); border:1px solid rgba(255,255,255,0.06); padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px; outline:none; appearance:none; }
    .select-wrap{ position:relative; display:inline-block } .select-wrap::after{ content:"‚ñæ"; position:absolute; right:10px; top:50%; transform:translateY(-50%); pointer-events:none; color:var(--muted); font-size:12px; }
    .btn-primary{ background:linear-gradient(90deg,var(--primary-color), rgba(30,91,79,0.9)); color:#fff; border:none; box-shadow:0 8px 24px rgba(30,91,79,0.12) }
    .btn{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer }
    label.small{ font-size:13px; color:var(--muted); margin-left:6px; user-select:none; }
    .card{ background: var(--card); padding:16px; border-radius:12px; border:1px solid #e9ecef; box-shadow:0 4px 12px rgba(39, 39, 39, 0.04); }
    .charts{ display:grid; gap:12px; grid-template-rows:auto 260px }
    #chart-main{ height:520px } #chart-stack{ height:220px } #chart-donut{ height:320px }
    .sidebar{ display:flex; flex-direction:column; gap:12px }
    .kpis{ display:grid; gap:8px; grid-template-columns:1fr 1fr } .kpi{ padding:10px; border-radius:10px; background:rgba(255,255,255,0.01) }
    .mini-sparklines{ display:grid; gap:8px; margin-top:8px } .sparkline{ height:70px; padding:6px; border-radius:8px; background:rgba(255,255,255,0.01); display:flex; align-items:center; justify-content:space-between }
    .legend{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; max-height:60px; overflow:auto; padding-right:6px; }
    footer.small{ grid-column:1/-1; text-align:center; color:var(--muted); font-size:12px; margin-top:16px; padding-top: 16px; border-top: 1px solid #e9ecef; }
    @media (max-width:1100px){ .container{ grid-template-columns:1fr; padding:10px } #chart-main{ height:380px } }

    /* Tab Styles */
    .tabs { padding: 0 16px; max-width: 1320px; margin: 16px auto 0; }
    .tab-buttons { border-bottom: 1px solid #dee2e6; }
    .tab-btn { background: transparent; border: none; padding: 10px 16px; cursor: pointer; font-size: 15px; color: var(--muted); border-bottom: 2px solid transparent; margin-bottom: -1px; }
    .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
<div class="dashboard-wrapper">
  <div class="tabs">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="produccion">Producci√≥n Industria Textil</button>
      <button class="tab-btn" data-tab="dependencias">Dependencias - Uniformes</button>
    </div>
  </div>

<div id="produccion" class="tab-pane active">
  <div class="container">
    <header>
      <div>
        <h1>üìä Dashboard de la Industria Textil</h1>
        <p class="lead">An√°lisis evolutivo de la producci√≥n y ventas del sector textil, segmentado por clave de actividad econ√≥mica (SCIAN). Las m√©tricas de valor se presentan en miles de pesos y las de cantidad en las unidades correspondientes a cada actividad.</p>
      </div>

      <div class="controls">
        <div class="select-wrap"><select id="metric" title="Selecciona m√©trica">
          <option value="valor_produccion">Valor producci√≥n (miles)</option>
          <option value="cantidad_produccion">Cantidad producci√≥n</option>
          <option value="valor_ventas">Valor ventas (miles)</option>
          <option value="cantidad_ventas">Cantidad ventas</option>
        </select></div>

        <label style="display:flex;align-items:center"><input type="checkbox" id="logScale" /><span class="small" style="margin-left:6px;color:var(--muted)">Log</span></label>
        <label style="display:flex;align-items:center"><input type="checkbox" id="normalize" /><span class="small" style="margin-left:6px;color:var(--muted)">Normalizar</span></label>
        <label style="display:flex;align-items:center"><input type="checkbox" id="showTotals" /><span class="small" style="margin-left:6px;color:var(--muted)">Mostrar Totales</span></label>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnPlay" class="btn-primary">‚ñ∂ Play</button>
          <button id="btnExport" class="btn" title="Exportar PNG">üì∑</button>
          <button id="btnCSV" class="btn">‚¨á CSV</button>
        </div>
      </div>
    </header>

    <section class="charts" style="grid-template-rows: auto auto 260px;">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong id="title-main">Evoluci√≥n de la M√©trica Principal</strong>
          <div class="legend" id="legendContainer"></div>
        </div>
        <div id="chart-main"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <strong>Distribuci√≥n por Actividad (√öltimo A√±o)</strong>
          <div style="display:flex;gap:8px;align-items:center">
            <label style="font-size:12px;color:var(--muted)">Umbral "Otros" %:</label>
            <input id="otrosThreshold" type="number" min="0" max="10" step="0.1" value="1" style="width:72px" />
          </div>
        </div>
        <div id="chart-donut"></div>
        <small style="color:var(--muted)">"Otros" agrupa las actividades con una participaci√≥n menor al umbral. El tooltip muestra el detalle.</small>
      </div>
    </section>

    <aside class="sidebar">
      <div class="card"><strong>Stacked (por a√±o)</strong><div id="chart-stack"></div></div>

      <div class="card"><strong>KPI / Totales</strong><div class="kpis" id="kpiContainer" style="margin-top:8px;"></div><small style="color:var(--muted);display:block;margin-top:8px;">Activa "Mostrar Totales" para la serie agregada.</small></div> 
      <div class="card"><strong>Tendencias Individuales por Actividad</strong><div class="mini-sparklines" id="sparks"></div></div>
    </aside>

    <footer class="small">Dashboard interactivo para el an√°lisis de la producci√≥n textil.</footer>
  </div>
</div>

<div id="dependencias" class="tab-pane">
  <div class="container" style="min-height: 70vh; display: flex; align-items: center; justify-content: center;">
      <p style="color: var(--muted); font-size: 1.2rem;">Contenido para "Dependencias - Uniformes" aparecer√° aqu√≠.</p>
  </div>
</div>
</div>

  <script>
    /* === rawData (misma estructura que antes) === */
    const rawData = [
      // (usa exactamente tus filas; acort√© aqu√≠ por brevedad en el snippet, pega tu tabla completa)
      {anio:2018, clave:"313210", actividad:"Fabricaci√≥n de telas anchas de tejido de trama", cantidad_produccion:199648, valor_produccion:24954414, cantidad_ventas:196167, valor_ventas:24794544},
      {anio:2018, clave:"313240", actividad:"Fabricaci√≥n de telas de tejido de punto", cantidad_produccion:30133, valor_produccion:5631546, cantidad_ventas:28814, valor_ventas:5291519},
      {anio:2018, clave:"314120", actividad:"Confecci√≥n de cortinas, blancos y similares", cantidad_produccion:26186843, valor_produccion:8407726, cantidad_ventas:25557374, valor_ventas:8218987},
      {anio:2018, clave:"315223", actividad:"Confecci√≥n en serie de uniformes", cantidad_produccion:0, valor_produccion:10414202, cantidad_ventas:0, valor_ventas:10398026},
      {anio:2019, clave:"313210", actividad:"Fabricaci√≥n de telas anchas de tejido de trama", cantidad_produccion:175691, valor_produccion:23090108, cantidad_ventas:175298, valor_ventas:23073541},
      {anio:2019, clave:"313240", actividad:"Fabricaci√≥n de telas de tejido de punto", cantidad_produccion:28949, valor_produccion:5368944, cantidad_ventas:28313, valor_ventas:5143181},
      {anio:2019, clave:"314120", actividad:"Confecci√≥n de cortinas, blancos y similares", cantidad_produccion:23245858, valor_produccion:8619546, cantidad_ventas:22533241, valor_ventas:8377031},
      {anio:2019, clave:"315223", actividad:"Confecci√≥n en serie de uniformes", cantidad_produccion:0, valor_produccion:11336314, cantidad_ventas:0, valor_ventas:11319459},
      {anio:2020, clave:"313210", actividad:"Fabricaci√≥n de telas anchas de tejido de trama", cantidad_produccion:123524, valor_produccion:17124026, cantidad_ventas:124053, valor_ventas:17249444},
      {anio:2020, clave:"313240", actividad:"Fabricaci√≥n de telas de tejido de punto", cantidad_produccion:19685, valor_produccion:4025437, cantidad_ventas:19347, valor_ventas:3879325},
      {anio:2020, clave:"314120", actividad:"Confecci√≥n de cortinas, blancos y similares", cantidad_produccion:20147693, valor_produccion:7846613, cantidad_ventas:19769280, valor_ventas:7747410},
      {anio:2020, clave:"315223", actividad:"Confecci√≥n en serie de uniformes", cantidad_produccion:0, valor_produccion:10813381, cantidad_ventas:0, valor_ventas:10789575},
      {anio:2021, clave:"313210", actividad:"Fabricaci√≥n de telas anchas de tejido de trama", cantidad_produccion:185995, valor_produccion:23795265, cantidad_ventas:185305, valor_ventas:23685156},
      {anio:2021, clave:"313240", actividad:"Fabricaci√≥n de telas de tejido de punto", cantidad_produccion:28438, valor_produccion:5708733, cantidad_ventas:28780, valor_ventas:5720500},
      {anio:2021, clave:"314120", actividad:"Confecci√≥n de cortinas, blancos y similares", cantidad_produccion:26938373, valor_produccion:10184153, cantidad_ventas:25697116, valor_ventas:9734413},
      {anio:2021, clave:"315223", actividad:"Confecci√≥n en serie de uniformes", cantidad_produccion:0, valor_produccion:10585090, cantidad_ventas:0, valor_ventas:10518458},
      {anio:2022, clave:"313210", actividad:"Fabricaci√≥n de telas anchas de tejido de trama", cantidad_produccion:180121, valor_produccion:25640119, cantidad_ventas:177303, valor_ventas:25393559},
      {anio:2022, clave:"313240", actividad:"Fabricaci√≥n de telas de tejido de punto", cantidad_produccion:29980, valor_produccion:6382197, cantidad_ventas:29525, valor_ventas:6197043},
      {anio:2022, clave:"314120", actividad:"Confecci√≥n de cortinas, blancos y similares", cantidad_produccion:23061566, valor_produccion:8949533, cantidad_ventas:22900874, valor_ventas:8879401},
      {anio:2022, clave:"315223", actividad:"Confecci√≥n en serie de uniformes", cantidad_produccion:0, valor_produccion:12414478, cantidad_ventas:0, valor_ventas:12451851},
      {anio:2023, clave:"313210", actividad:"Fabricaci√≥n de telas anchas de tejido de trama", cantidad_produccion:147570, valor_produccion:21501857, cantidad_ventas:146357, valor_ventas:21390298},
      {anio:2023, clave:"313240", actividad:"Fabricaci√≥n de telas de tejido de punto", cantidad_produccion:25428, valor_produccion:5086594, cantidad_ventas:24848, valor_ventas:4822981},
      {anio:2023, clave:"314120", actividad:"Confecci√≥n de cortinas, blancos y similares", cantidad_produccion:22071379, valor_produccion:8570446, cantidad_ventas:21780225, valor_ventas:8462449},
      {anio:2023, clave:"315223", actividad:"Confecci√≥n en serie de uniformes", cantidad_produccion:0, valor_produccion:13141060, cantidad_ventas:0, valor_ventas:13137455},
      {anio:2024, clave:"313210", actividad:"Fabricaci√≥n de telas anchas de tejido de trama", cantidad_produccion:139766, valor_produccion:19816670, cantidad_ventas:139492, valor_ventas:19790097},
      {anio:2024, clave:"313240", actividad:"Fabricaci√≥n de telas de tejido de punto", cantidad_produccion:22976, valor_produccion:4274791, cantidad_ventas:22622, valor_ventas:4143232},
      {anio:2024, clave:"314120", actividad:"Confecci√≥n de cortinas, blancos y similares", cantidad_produccion:22988318, valor_produccion:8586298, cantidad_ventas:22547345, valor_ventas:8506680},
      {anio:2024, clave:"315223", actividad:"Confecci√≥n en serie de uniformes", cantidad_produccion:0, valor_produccion:14307593, cantidad_ventas:0, valor_ventas:14251670},
      {anio:2025, clave:"313210", actividad:"Fabricaci√≥n de telas anchas de tejido de trama", cantidad_produccion:87645, valor_produccion:12361492, cantidad_ventas:87792, valor_ventas:12375517},
      {anio:2025, clave:"313240", actividad:"Fabricaci√≥n de telas de tejido de punto", cantidad_produccion:14410, valor_produccion:2405121, cantidad_ventas:14349, valor_ventas:2395648},
      {anio:2025, clave:"314120", actividad:"Confecci√≥n de cortinas, blancos y similares", cantidad_produccion:14294533, valor_produccion:5300761, cantidad_ventas:14192996, valor_ventas:5287447},
      {anio:2025, clave:"315223", actividad:"Confecci√≥n en serie de uniformes", cantidad_produccion:0, valor_produccion:10092397, cantidad_ventas:0, valor_ventas:10102496},
    ];

    function cssVar(n){ return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }
    const primary = cssVar('--primary-color') || '#1E5B4F';
    const palette = [primary, cssVar('--secondary-color')||'#A6802D', cssVar('--accent-color')||'#9C2348', '#3A82A8', '#6A3E7A', '#9A5A2A', '#5C8A3A', '#D07A4A'];

    const years = Array.from(new Set(rawData.map(r=> r.anio))).sort((a,b)=>a-b);
    const activities = Array.from(new Set(rawData.map(r=> r.actividad)));
    const nf = new Intl.NumberFormat('es-MX');

    // --- INICIO: SOLUCI√ìN ---
    // Formateador inteligente para abreviar n√∫meros grandes en los ejes (ej. 1.2M, 500k)
    function axisLabelFormatter(v) {
      if (Math.abs(v) >= 1e6) return (v / 1e6).toFixed(1) + 'M';
      if (Math.abs(v) >= 1e3) return (v / 1e3).toFixed(0) + 'k';
      return v;
    }
    // --- FIN: SOLUCI√ìN ---

    // seriesMap
    const seriesMap = {};
    activities.forEach(act => {
      const rows = years.map(y => rawData.find(r=> r.actividad===act && r.anio===y) || null);
      seriesMap[act] = {
        clave: (rows.find(r=>r) || {}).clave || '',
        valor_produccion: rows.map(r => r? r.valor_produccion : 0),
        cantidad_produccion: rows.map(r => r? r.cantidad_produccion : 0),
        valor_ventas: rows.map(r => r? r.valor_ventas : 0),
        cantidad_ventas: rows.map(r => r? r.cantidad_ventas : 0)
      };
    });

    function metricKey(metric, act, idx){
      const s = seriesMap[act];
      return s ? (s[metric][idx] || 0) : 0;
    }
    function totalsByYear(metric){ return years.map((y, yi) => activities.reduce((acc, a) => acc + (metricKey(metric, a, yi)||0), 0)); }

    const main = echarts.init(document.getElementById('chart-main'), null, {renderer:'canvas'});
    const stack = echarts.init(document.getElementById('chart-stack'), null, {renderer:'canvas'});
    const donut = echarts.init(document.getElementById('chart-donut'), null, {renderer:'canvas'});

    function groupSmallSlices(rawSlices, thresholdPercent=1){
      const total = rawSlices.reduce((s,r)=> s+(r.value||0),0) || 1;
      const big = [], small = [];
      rawSlices.forEach(r => { const pct = (r.value/total)*100; (isNaN(pct) || pct < thresholdPercent) ? small.push(r) : big.push({...r, pct}); });
      if(small.length){
        const othersValue = small.reduce((s,r)=>s+(r.value||0),0);
        big.push({ name:'Otros', value: othersValue, itemStyle:{ color:'#666' }, pct: (othersValue/total)*100 });
      }
      big.sort((a,b)=> (b.value||0) - (a.value||0));
      return big;
    }

    function buildMainOptions(metric, { useLog=false, normalize=false, showTotals=false } = {}){
      const labelMap = { valor_produccion:'Valor de producci√≥n (miles)', cantidad_produccion:'Cantidad de producci√≥n', valor_ventas:'Valor de ventas (miles)', cantidad_ventas:'Cantidad ventas' };
      document.getElementById('title-main').textContent = `Evoluci√≥n de: ${labelMap[metric]}`;

      if(showTotals){
        let totals = totalsByYear(metric);
        if(normalize){
          const first = totals.find(v=>v>0);
          totals = first ? totals.map(v=> v? (v/first)*100 : null) : totals.map(_=>null);
        } else if(useLog){
          totals = totals.map(v => v===0? null : v);
        }
        const opt = {
          backgroundColor:'transparent',
          tooltip:{ trigger:'axis', formatter: p => `<strong>${p[0].axisValue}</strong><br/>Total: <strong>${nf.format(Math.round(p[0].data*100)/100)}</strong>` },
          xAxis:{ type:'category', data: years, axisLabel:{ color: cssVar('--text') } },
          yAxis: useLog ? { type:'log', logBase:10, axisLabel:{ color: cssVar('--text'), formatter: axisLabelFormatter } } : { axisLabel:{ color: cssVar('--text'), formatter: axisLabelFormatter } },
          series:[{ name:'Total', type:'line', smooth:true, data: totals, itemStyle:{ color: primary }, areaStyle:{ opacity:0.14 }, lineStyle:{ width:3 } }],
          grid:{ left:'6%', right:'8%', top:90, bottom:70 },
          dataZoom:[{ type:'inside', start:0, end:100 }, { start:0, end:100 }]
        };
        return opt;
      }
 
      const rawSeries = activities.map((act, idx) => {
        const arr = years.map((y, yi) => metricKey(metric, act, yi) || 0);
        return { name: act, data: arr.map(v => v===0? (useLog? null : 0) : v), color: palette[idx%palette.length], raw: arr };
      });

      const seriesPrepared = rawSeries.map(s => {
        if(normalize){
          const first = s.raw.find(v=>v>0);
          return first ? {...s, data: s.raw.map(v => v? (v/first)*100 : null), itemStyle:{ color: s.color }} : {...s, data:s.raw.map(_=>null), itemStyle:{ color:s.color }};
        }
        return {...s, itemStyle:{ color:s.color }};
      });

      return {
        backgroundColor:'transparent',
        tooltip:{ 
          trigger:'axis', 
          axisPointer:{ type:'cross' }, 
          textStyle: { fontSize: 12 }, // Tooltip m√°s peque√±o
          formatter: params => {
            const year = params[0].axisValue; 
            let s = `<strong style="font-size:13px;">${year}</strong><br/>`;
            params.forEach(p => { 
              const seriesName = p.seriesName.length > 40 ? p.seriesName.substring(0, 38) + '...' : p.seriesName;
              s += `<div style="display:flex;align-items:center;margin-top:4px;"><span style="display:inline-block;margin-right:6px;width:10px;height:10px;background:${p.color};border-radius:2px;"></span> ${seriesName}: <strong style="margin-left:auto;padding-left:12px;">${p.data==null ? '‚Äî' : nf.format(Math.round(p.data*100)/100)}</strong></div>`; 
            });
            return s;
          }},
        legend:{ type:'scroll', top:44, textStyle:{ color: cssVar('--muted') } },
        toolbox:{ feature:{ saveAsImage:{ title:'Guardar PNG' } }, right:12 },
        xAxis:{ type:'category', boundaryGap:false, data: years, axisLabel:{ color: cssVar('--text') } },
        yAxis: useLog ? { type:'log', logBase:10, axisLabel:{ color: cssVar('--text'), formatter: axisLabelFormatter } } : { type:'value', axisLabel:{ color: cssVar('--text'), formatter: axisLabelFormatter } },
        dataZoom:[{ type:'inside', start:0, end:100 }, { start:0, end:100 }],
        grid:{ left:'6%', right:'8%', top:90, bottom:70 },
        series: seriesPrepared.map(s=>({ name:s.name, type:'line', smooth:true, showSymbol:true, symbolSize:6, areaStyle:{ opacity:0.12 }, lineStyle:{ width:3 }, itemStyle: s.itemStyle, data: s.data }))
      };
    }

    function buildStackOptions(metric){
      const seriesOpt = activities.map((act, idx) => ({ name:act, type:'bar', stack:'total', itemStyle:{ color: palette[idx%palette.length] }, data: years.map((y, yi) => metricKey(metric, act, yi)||0) }));
      return { backgroundColor:'transparent', tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' } }, legend:{ show:false }, grid:{ left:'3%', right:'4%', bottom:'3%', top:20, containLabel:true }, xAxis:{ type:'category', data: years, axisLabel:{ color: cssVar('--text') } }, yAxis:{ axisLabel:{ color: cssVar('--text'), formatter: axisLabelFormatter } }, series: seriesOpt };
    }

    function buildDonutOptions(metric, year, otrosThresholdPercent=1){
      const rawSlices = activities.map((act,i) => {
        const row = rawData.find(r=> r.actividad===act && r.anio===year) || {cantidad_produccion:0, valor_produccion:0, cantidad_ventas:0, valor_ventas:0};
        const val = metric==='valor_produccion'? row.valor_produccion : metric==='cantidad_produccion'? row.cantidad_produccion : metric==='valor_ventas'? row.valor_ventas : row.cantidad_ventas;
        return { name: act, value: val, itemStyle:{ color: palette[i%palette.length] }, orig: row };
      });
      const grouped = groupSmallSlices(rawSlices, otrosThresholdPercent);

      return {
        tooltip:{ trigger:'item', formatter: params => {
          if(params.name === 'Otros'){
            const smalls = rawSlices.filter(r => grouped.every(g => g.name !== r.name));
            const smallList = smalls.map(s => `${s.name}: ${nf.format(s.value)}`).join('<br/>');
            return `<strong>Otros</strong><br/>Total: <strong>${nf.format(params.value)}</strong><br/><small>${smallList}</small>`;
          } else {
            return `<strong>${params.name}</strong><br/>Valor: <strong>${nf.format(params.value)}</strong>`;
          }
        }},
        legend:{ orient:'vertical', left:'right', top:20, bottom:20, textStyle:{ color: cssVar('--muted') }, width:160 },
        series:[{
          type:'pie',
          radius:['42%','68%'],
          center:['40%','50%'],
          avoidLabelOverlap:true,
          label:{ show:true, position:'outside', formatter:'{b}\n{d}%', color: cssVar('--text') },
          labelLine:{ length:10, length2:8 },
          labelLayout:{ hideOverlap:true, moveOverlap:'shiftY' },
          emphasis:{ itemStyle:{ shadowBlur:10, shadowOffsetX:0, shadowColor:'rgba(0,0,0,0.5)' } },
          data: grouped
        }]
      };
    }

    // Render engine (usando notMerge:true al actualizar main y donut para evitar merge)
    const metricSel = document.getElementById('metric');
    const logChk = document.getElementById('logScale');
    const normChk = document.getElementById('normalize');
    const showTotalsChk = document.getElementById('showTotals');
    const otrosThresholdInput = document.getElementById('otrosThreshold');

    function renderAll(){
      const metric = metricSel.value;
      const useLog = logChk.checked;
      const normalize = normChk.checked;
      const showTotals = showTotalsChk.checked;

      // Validar log: si no hay valores positivos, desactivar
      if(useLog){
        const maxVal = Math.max(...years.flatMap((y, yi) => activities.map(a => metricKey(metric, a, yi))));
        if(maxVal <= 0){
          logChk.checked = false;
          alert('Log scale requiere valores positivos. Se ha desactivado Log.');
        }
      }

      // IMPORTANT: use notMerge:true for main and donut to fully replace options (evita que estilos antiguos "persistan")
      main.setOption(buildMainOptions(metric, { useLog: logChk.checked, normalize: normChk.checked, showTotals }), true);
      stack.setOption(buildStackOptions(metric)); // stack use merge ok
      const lastYear = Math.max(...years);
      donut.setOption(buildDonutOptions(metric, lastYear, parseFloat(otrosThresholdInput.value) || 1), true);

      renderLegend();
      renderKPIs(metric);
      renderSparklines(metric, { useLog: logChk.checked, normalize: normChk.checked });
    }

    function renderLegend(){
      const container = document.getElementById('legendContainer'); container.innerHTML = '';
      activities.forEach((act,i) => {
        const pill = document.createElement('div'); pill.style.display='flex'; pill.style.alignItems='center'; pill.style.gap='8px'; pill.style.padding='6px 8px'; pill.style.borderRadius='999px'; pill.style.background='rgba(255,255,255,0.01)'; pill.style.fontSize='12px'; pill.style.cursor='pointer'; pill.title = act;
        const sw = document.createElement('span'); sw.style.width='12px'; sw.style.height='12px'; sw.style.display='inline-block'; sw.style.background = palette[i%palette.length]; sw.style.borderRadius='3px';
        pill.appendChild(sw); const txt = document.createElement('span'); txt.style.color='var(--muted)'; txt.textContent = `${seriesMap[act].clave}`; pill.appendChild(txt);
        pill.onclick = () => {
          const opt = main.getOption();
          const idx = opt.series.findIndex(s => s.name === act);
          if(idx >= 0){
            opt.series[idx].lineStyle = opt.series[idx].lineStyle || {}; opt.series[idx].itemStyle = opt.series[idx].itemStyle || {};
            const hidden = opt.series[idx].lineStyle.opacity === 0.15;
            opt.series[idx].lineStyle.opacity = hidden ? 1 : 0.15; opt.series[idx].itemStyle.opacity = hidden ? 1 : 0.15;
            main.setOption(opt);
          }
        };
        container.appendChild(pill);
      });
    }

    function renderKPIs(metric){
      const totals = totalsByYear(metric); const last = totals[totals.length-1]||0; const prev = totals[totals.length-2]||0; const diff = prev===0?0:((last-prev)/prev)*100;
      const kpiContainer = document.getElementById('kpiContainer'); kpiContainer.innerHTML = '';
      const a = document.createElement('div'); a.className='kpi'; a.innerHTML = `<div style="font-size:13px;color:var(--muted)">Total ${metric.includes('valor')? 'valor (miles)': 'cantidad'} (${years[years.length-1]})</div><div style="font-size:18px;font-weight:700">${nf.format(last)}</div><div style="color:${diff>=0? '#8ef':'#f88'};font-size:12px;font-weight:bold;">${diff>=0? '‚ñ≤ '+diff.toFixed(1)+'%': '‚ñº '+diff.toFixed(1)+'%'} <span style="font-weight:normal;color:var(--muted);">vs ${years[years.length-2]}</span></div>`; kpiContainer.appendChild(a);
      const b = document.createElement('div'); b.className='kpi'; b.innerHTML = `<div style="font-size:13px;color:var(--muted)">A√±os en vista</div><div style="font-size:18px;font-weight:700">${years.length}</div><div style="color:var(--muted);font-size:12px">Desde ${years[0]} hasta ${years[years.length-1]}</div>`; kpiContainer.appendChild(b);

      activities.forEach((act,i) => {
        const row = rawData.find(r => r.actividad === act && r.anio === years[years.length-1]) || {cantidad_produccion:0, valor_produccion:0, cantidad_ventas:0, valor_ventas:0};
        const node = document.createElement('div'); node.className='kpi'; node.style.gridColumn='1/-1';
        const value = (()=>{ if(metric==='valor_produccion') return row.valor_produccion; if(metric==='cantidad_produccion') return row.cantidad_produccion; if(metric==='valor_ventas') return row.valor_ventas; return row.cantidad_ventas; })();
        node.innerHTML = `<div style="font-size:13px;color:var(--muted)">${act} (${seriesMap[act].clave})</div><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">${nf.format(value)}</div><div style="font-size:12px;color:var(--muted)">${years[years.length-1]}</div></div>`;
        kpiContainer.appendChild(node);
      });
    }

    function renderSparklines(metric, { useLog=false, normalize=false } = {}){
      const sparks = document.getElementById('sparks'); sparks.innerHTML = '';
      activities.forEach((act,i) => {
        const wrapper = document.createElement('div'); wrapper.className='sparkline';
        const left = document.createElement('div'); left.style.flex='1';
        const title = document.createElement('div'); title.style.fontSize='12px'; title.style.color='var(--muted)'; title.textContent = seriesMap[act].clave;
        const last = metricKey(metric, act, years.length-1)||0; const val = document.createElement('div'); val.style.fontWeight='700'; val.style.fontSize='13px'; val.textContent = nf.format(last);
        left.appendChild(title); left.appendChild(val);
        const chartBox = document.createElement('div'); chartBox.style.width='140px'; chartBox.style.height='70px';
        wrapper.appendChild(left); wrapper.appendChild(chartBox); sparks.appendChild(wrapper);
        const mini = echarts.init(chartBox, null, {renderer:'canvas'});
        let data = years.map((y, yi) => metricKey(metric, act, yi) || 0);
        if(normalize){ const first = data.find(v=>v>0); data = first? data.map(v=> v? (v/first)*100:null): data.map(_=>null); } else if(useLog){ data = data.map(v=> v===0? null : v); }
        mini.setOption({ grid:{ left:6, right:6, top:6, bottom:6 }, xAxis:{ show:false, type:'category', data: years }, yAxis:{ show:false, type:'value' }, series:[{ type:'line', data, smooth:true, lineStyle:{ width:2, color: palette[i%palette.length] }, areaStyle:{ opacity:0.06 } }] });
      });
    }

    document.getElementById('btnCSV').addEventListener('click', () => {
      const keys = ['anio','clave','actividad','cantidad_produccion','valor_produccion','cantidad_ventas','valor_ventas'];
      const rows = [keys.join(',')]; rawData.forEach(r=> rows.push(keys.map(k=> (r[k]==null? '' : String(r[k]).replace(/,/g,''))).join(',')));
      const csv = rows.join('\n'); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='produccion_textil_v4_1.csv'; a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('btnExport').addEventListener('click', () => { const url = main.getDataURL({ pixelRatio:2, backgroundColor:'#071422' }); const a = document.createElement('a'); a.href = url; a.download = 'evolucion_produccion_v4_1.png'; a.click(); });

    // Play
    let playTimer = null; let playIndex = 0;
    function playToggle(){ const btn = document.getElementById('btnPlay'); if(playTimer){ clearInterval(playTimer); playTimer=null; btn.textContent='‚ñ∂ Play'; return; } btn.textContent='‚è∏ Pausa'; playIndex=0; playTimer=setInterval(()=>{ const year = years[playIndex%years.length]; const pos = (playIndex/(years.length-1))*100; main.dispatchAction({ type:'dataZoom', start: Math.max(0,pos-10), end: Math.min(100,pos+10) }); donut.setOption(buildDonutOptions(metricSel.value, year, parseFloat(otrosThresholdInput.value)||1), true); playIndex++; }, 900); }
    document.getElementById('btnPlay').addEventListener('click', playToggle);

    // donut click toggles series in main (skip 'Otros')
    donut.on('click', params => { const name = params.name; if(name==='Otros') return; const opt = main.getOption(); const idx = opt.series.findIndex(s=> s.name === name); if(idx>=0){ opt.series[idx].lineStyle = opt.series[idx].lineStyle || {}; opt.series[idx].itemStyle = opt.series[idx].itemStyle || {}; const hidden = opt.series[idx].lineStyle.opacity === 0.15; opt.series[idx].lineStyle.opacity = hidden ? 1 : 0.15; opt.series[idx].itemStyle.opacity = hidden ? 1 : 0.15; main.setOption(opt); } });
 
    metricSel.addEventListener('change', renderAll);
    logChk.addEventListener('change', renderAll);
    normChk.addEventListener('change', renderAll);
    showTotalsChk.addEventListener('change', renderAll);
    otrosThresholdInput.addEventListener('change', renderAll);
    
    // Tab switching logic
    document.querySelector('.tab-buttons').addEventListener('click', (e) => {
      if (e.target.matches('.tab-btn')) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        e.target.classList.add('active');
        document.getElementById(e.target.dataset.tab).classList.add('active');
      }
    });

    function init(){ renderAll(); window.addEventListener('resize', ()=>{ main.resize(); stack.resize(); donut.resize(); }); }    init();
  </script>
</body>
</html>
